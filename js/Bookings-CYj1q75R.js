import{J as w,F as me,j as a,p as ue,h as Q,B as n,a0 as he,I as S,a1 as h,V as W}from"./index-DTpEtvuZ.js";import{r as c}from"./react-vendor-BQWX9zlF.js";import{S as T}from"./Select-B3cAiPFK.js";import{T as X}from"./Textarea-Mp-xS5Mj.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-mpaoXh-M.js";import"./form-vendor-BjD3cHyu.js";const pe="_bookings_cyuy7_1",ve="_title_cyuy7_5",xe="_tabs_cyuy7_10",je="_tab_cyuy7_10",ye="_tabActive_cyuy7_39",_e="_empty_cyuy7_69",we="_list_cyuy7_75",Ne="_bookingCard_cyuy7_81",fe="_bookingHeader_cyuy7_85",Ce="_headerMain_cyuy7_94",ge="_clientName_cyuy7_98",Se="_procedureName_cyuy7_104",be="_metaLine_cyuy7_110",De="_status_cyuy7_116",Ie="_awaiting_cyuy7_129",ze="_completed_cyuy7_134",Re="_cancelled_cyuy7_139",Le="_bookingInfo_cyuy7_144",Ve="_infoRow_cyuy7_148",Ae="_label_cyuy7_154",Te="_phone_cyuy7_160",ke="_comment_cyuy7_169",Be="_actions_cyuy7_181",Fe="_modalContent_cyuy7_189",Ee="_formGrid_cyuy7_194",Me="_modalGrid_cyuy7_199",$e="_modalRow_cyuy7_204",Pe="_modalLabel_cyuy7_211",Ge="_modalValue_cyuy7_216",He="_modalActions_cyuy7_221",t={bookings:pe,title:ve,tabs:xe,tab:je,tabActive:ye,empty:_e,list:we,bookingCard:Ne,bookingHeader:fe,headerMain:Ce,clientName:ge,procedureName:Se,metaLine:be,status:De,new:"_new_cyuy7_123",awaiting:Ie,completed:ze,cancelled:Re,bookingInfo:Le,infoRow:Ve,label:Ae,phone:Te,comment:ke,actions:Be,modalContent:Fe,formGrid:Ee,modalGrid:Me,modalRow:$e,modalLabel:Pe,modalValue:Ge,modalActions:He};function Ue(m){return m==="processed"?"awaiting":m}function Y(m,b){const N=new Date(m),[j,p]=String(b||"").split(":").map(D=>Number(D));return Number.isFinite(j)&&Number.isFinite(p)&&N.setHours(j,p,0,0),N}const Ye=()=>{const[m,b]=c.useState([]),[N,j]=c.useState(!0),[p,D]=c.useState("new"),[s,o]=c.useState(null),[Z,ee]=c.useState(!1),[y,ae]=c.useState([]),[v,u]=c.useState("view"),[x,f]=c.useState(!1),[C,k]=c.useState(""),[I,B]=c.useState(""),[z,F]=c.useState(""),[R,E]=c.useState(""),[M,$]=c.useState(""),[L,P]=c.useState(""),[V,G]=c.useState(""),[A,H]=c.useState(""),[U,O]=c.useState("asBooked");c.useEffect(()=>{const e=window.matchMedia("(max-width: 768px)"),l=()=>ee(e.matches);return l(),e.addEventListener?.("change",l),()=>e.removeEventListener?.("change",l)},[]),c.useEffect(()=>{g()},[p]);const g=async()=>{try{j(!0);let l=await w.getAll();const i=await me.getAll({includeArchived:!0});ae(i),l=l.map(d=>{if(!d.procedureName&&d.procedureId){const _=i.find(oe=>oe.id===d.procedureId);if(_)return{...d,procedureName:_.name}}return d}),l=l.filter(d=>Ue(d.status)===p),b(l)}catch(e){console.error("Ошибка загрузки заявок:",e)}finally{j(!1)}},r=async(e,l)=>{try{if(await w.update(e,{status:l}),l==="completed"){const i=m.find(d=>d.id===e);i&&await se(i)}await g()}catch(i){console.error("Ошибка обновления статуса:",i),alert("Ошибка при обновлении статуса")}},se=async e=>{try{const l=y.find(d=>d.id===e.procedureId);let i=await h.getByPhone(e.phone);if(!i){const d=await h.create({phone:e.phone,name:e.name,email:e.email,totalVisits:0});i=await h.get(d)}if(i){const d=Y(e.desiredDate,e.desiredTime);await W.create({clientId:i.id,clientPhone:e.phone,clientName:e.name,procedureId:e.procedureId,procedureName:e.procedureName,date:d,price:l?.price??0,notes:e.comment||void 0,bookingId:e.id});const _=(i.totalVisits||0)+1;await h.update(i.id,{totalVisits:_,lastVisit:d})}}catch(l){console.error("Ошибка создания записи об услуге:",l)}},q=c.useMemo(()=>y.map(e=>({value:e.id,label:`${e.name}${e.archived?" (архив)":""}`})),[y]),J=e=>{o(e),u("view")},te=()=>{s&&(k(s.procedureId||""),B(s.desiredDate||""),F(s.desiredTime||""),E(s.comment||""),u("edit"))},le=()=>{s&&($(s.procedureId||""),P(s.desiredDate||""),G(s.desiredTime||""),H(s.comment||""),O(s.status==="completed"?"asCompleted":"asBooked"),u("add"))},ie=async()=>{if(s)try{f(!0);const e=y.find(i=>i.id===C);await w.update(s.id,{procedureId:C,procedureName:e?.name||s.procedureName,desiredDate:I,desiredTime:z,comment:R||""});const l={...s,procedureId:C,procedureName:e?.name||s.procedureName,desiredDate:I,desiredTime:z,comment:R||""};o(l),u("view"),await g()}catch(e){console.error(e),alert("Не удалось сохранить изменения")}finally{f(!1)}},ne=async()=>{if(s)try{f(!0);const e=y.find(l=>l.id===M);if(!e){alert("Выберите процедуру");return}if(U==="asBooked"){const l=await w.create({name:s.name,phone:s.phone,email:s.email,procedureId:e.id,procedureName:e.name,desiredDate:L,desiredTime:V,comment:A||"",consent:!0});await w.update(l,{status:"awaiting"}),alert("Создана дополнительная запись (подтверждена).")}else{let l=await h.getByPhone(s.phone);if(!l){const i=await h.create({phone:s.phone,name:s.name,email:s.email,totalVisits:0});l=await h.get(i)}if(l){const i=Y(L,V);await W.create({clientId:l.id,clientPhone:s.phone,clientName:s.name,procedureId:e.id,procedureName:e.name,date:i,price:e.price??0,notes:A||void 0,bookingId:s.id});const d=(l.totalVisits||0)+1;await h.update(l.id,{totalVisits:d,lastVisit:i}),alert("Добавлена выполненная услуга (отчёты обновятся).")}}u("view"),await g()}catch(e){console.error(e),alert("Не удалось добавить процедуру")}finally{f(!1)}},ce=[{value:"new",label:"Новые (не обработаны)"},{value:"awaiting",label:"Записаны (подтверждены)"},{value:"completed",label:"Услуга оказана"},{value:"cancelled",label:"Отменено"}],K=e=>{switch(e){case"new":return"Новая";case"awaiting":return"Записана";case"completed":return"Услуга оказана";case"cancelled":return"Отменена";default:return e}},de=e=>{switch(e){case"new":return t.new;case"awaiting":return t.awaiting;case"completed":return t.completed;case"cancelled":return t.cancelled;default:return""}};if(N)return a.jsx(ue,{variant:"admin"});const re=(()=>{if(!s)return"";const e=s.desiredDate?new Date(s.desiredDate).toLocaleDateString("ru-RU"):"",l=s.desiredTime||"",i=[e,l].filter(Boolean).join(" • ");return i?`Заявка • ${s.name} • ${i}`:`Заявка • ${s.name}`})();return a.jsxs("div",{className:t.bookings,children:[a.jsx("h1",{className:t.title,children:"Заявки на запись"}),a.jsx("div",{className:t.tabs,children:ce.map(e=>a.jsx("button",{className:`${t.tab} ${p===e.value?t.tabActive:""}`,onClick:()=>D(e.value),children:e.label},e.value))}),m.length===0?a.jsx(Q,{className:t.empty,children:a.jsx("p",{children:"Заявок нет"})}):a.jsx("div",{className:t.list,children:m.map(e=>a.jsxs(Q,{className:t.bookingCard,onClick:()=>J(e),children:[a.jsxs("div",{className:t.bookingHeader,children:[a.jsxs("div",{className:t.headerMain,children:[a.jsx("h3",{className:t.clientName,children:e.name}),a.jsx("p",{className:t.procedureName,children:e.procedureName}),a.jsxs("p",{className:t.metaLine,children:[new Date(e.desiredDate).toLocaleDateString("ru-RU")," • ",e.desiredTime||"—"]})]}),a.jsx("span",{className:`${t.status} ${de(e.status)}`,children:K(e.status)})]}),!Z&&a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:t.bookingInfo,children:[a.jsxs("div",{className:t.infoRow,children:[a.jsx("span",{className:t.label,children:"Телефон:"}),a.jsx("a",{href:`tel:${e.phone}`,className:t.phone,children:e.phone})]}),e.email&&a.jsxs("div",{className:t.infoRow,children:[a.jsx("span",{className:t.label,children:"Email:"}),a.jsx("a",{href:`mailto:${e.email}`,children:e.email})]}),e.comment&&a.jsxs("div",{className:t.comment,children:[a.jsx("span",{className:t.label,children:"Комментарий:"}),a.jsx("p",{children:e.comment})]}),a.jsxs("div",{className:t.infoRow,children:[a.jsx("span",{className:t.label,children:"Дата заявки:"}),a.jsx("span",{children:new Date(e.createdAt).toLocaleString("ru-RU")})]})]}),a.jsxs("div",{className:t.actions,onClick:l=>l.stopPropagation(),children:[a.jsx(n,{size:"small",variant:"outline",onClick:()=>J(e),children:"Подробнее"}),e.status==="new"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",onClick:()=>r(e.id,"awaiting"),children:"Записать / подтвердить"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>r(e.id,"cancelled"),children:"Отменить"})]}),e.status==="awaiting"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",onClick:()=>r(e.id,"completed"),children:"Услуга оказана"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>r(e.id,"cancelled"),children:"Отменить"}),a.jsx(n,{size:"small",variant:"outline",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"})]}),e.status==="completed"&&a.jsx(n,{size:"small",variant:"outline",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"}),e.status==="cancelled"&&a.jsx(n,{size:"small",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"})]})]})]},e.id))}),a.jsx(he,{isOpen:!!s,onClose:()=>{o(null),u("view")},title:re,children:s&&a.jsxs("div",{className:t.modalContent,children:[v==="view"&&a.jsxs("div",{className:t.modalGrid,children:[a.jsxs("div",{className:t.modalRow,children:[a.jsx("div",{className:t.modalLabel,children:"Процедура"}),a.jsx("div",{className:t.modalValue,children:s.procedureName||"—"})]}),a.jsxs("div",{className:t.modalRow,children:[a.jsx("div",{className:t.modalLabel,children:"Дата/время"}),a.jsxs("div",{className:t.modalValue,children:[new Date(s.desiredDate).toLocaleDateString("ru-RU")," • ",s.desiredTime||"—"]})]}),a.jsxs("div",{className:t.modalRow,children:[a.jsx("div",{className:t.modalLabel,children:"Телефон"}),a.jsx("div",{className:t.modalValue,children:a.jsx("a",{href:`tel:${s.phone}`,children:s.phone})})]}),s.email&&a.jsxs("div",{className:t.modalRow,children:[a.jsx("div",{className:t.modalLabel,children:"Email"}),a.jsx("div",{className:t.modalValue,children:a.jsx("a",{href:`mailto:${s.email}`,children:s.email})})]}),s.comment&&a.jsxs("div",{className:t.modalRow,children:[a.jsx("div",{className:t.modalLabel,children:"Комментарий"}),a.jsx("div",{className:t.modalValue,children:s.comment})]}),a.jsxs("div",{className:t.modalRow,children:[a.jsx("div",{className:t.modalLabel,children:"Статус"}),a.jsx("div",{className:t.modalValue,children:K(s.status)})]})]}),v==="edit"&&a.jsxs("div",{className:t.formGrid,children:[a.jsx(T,{label:"Процедура",value:C,onChange:e=>k(e.target.value),options:q}),a.jsx(S,{label:"Дата",type:"date",value:I,onChange:e=>B(e.target.value)}),a.jsx(S,{label:"Время",type:"time",value:z,onChange:e=>F(e.target.value)}),a.jsx(X,{label:"Комментарий",value:R,onChange:e=>E(e.target.value)})]}),v==="add"&&a.jsxs("div",{className:t.formGrid,children:[a.jsx(T,{label:"Процедура",value:M,onChange:e=>$(e.target.value),options:q}),a.jsx(T,{label:"Создать как",value:U,onChange:e=>O(e.target.value),options:[{value:"asBooked",label:"Записанную (подтверждённую)"},{value:"asCompleted",label:"Выполненную услугу (в отчёты)"}],showDefaultOption:!1}),a.jsx(S,{label:"Дата",type:"date",value:L,onChange:e=>P(e.target.value)}),a.jsx(S,{label:"Время",type:"time",value:V,onChange:e=>G(e.target.value)}),a.jsx(X,{label:"Комментарий",value:A,onChange:e=>H(e.target.value)})]}),a.jsxs("div",{className:t.modalActions,children:[v==="view"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",variant:"outline",onClick:te,children:"Редактировать"}),a.jsx(n,{size:"small",variant:"outline",onClick:le,children:"Добавить процедуру"})]}),v==="edit"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",onClick:ie,disabled:x,children:x?"Сохранение…":"Сохранить"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>u("view"),disabled:x,children:"Отмена"})]}),v==="add"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",onClick:ne,disabled:x,children:x?"Создание…":"Создать"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>u("view"),disabled:x,children:"Отмена"})]}),s.status==="new"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",onClick:()=>r(s.id,"awaiting").then(()=>o(null)),children:"Записать / подтвердить"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>r(s.id,"cancelled").then(()=>o(null)),children:"Отменить"})]}),s.status==="awaiting"&&a.jsxs(a.Fragment,{children:[a.jsx(n,{size:"small",onClick:()=>r(s.id,"completed").then(()=>o(null)),children:"Услуга оказана"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>r(s.id,"cancelled").then(()=>o(null)),children:"Отменить"}),a.jsx(n,{size:"small",variant:"outline",onClick:()=>r(s.id,"new").then(()=>o(null)),children:"Вернуть в новые"})]}),s.status==="completed"&&a.jsx(n,{size:"small",variant:"outline",onClick:()=>r(s.id,"new").then(()=>o(null)),children:"Вернуть в новые"}),s.status==="cancelled"&&a.jsx(n,{size:"small",onClick:()=>r(s.id,"new").then(()=>o(null)),children:"Вернуть в новые"}),a.jsx(n,{size:"small",variant:"secondary",onClick:()=>o(null),children:"Закрыть"})]})]})})]})};export{Ye as default};
