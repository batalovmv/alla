import{y as h,z as I,j as t,p as z,h as v,B as m,M}from"./index-Cq7koZby.js";import{r as i}from"./react-vendor-BQWX9zlF.js";import{S as H}from"./Select-DnBbUO3U.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-CGxEfUHl.js";import"./form-vendor-BjD3cHyu.js";const L="_reviews_hrf2p_1",P="_header_hrf2p_5",D="_title_hrf2p_12",E="_empty_hrf2p_22",F="_list_hrf2p_28",O="_reviewCard_hrf2p_34",A="_reviewHeader_hrf2p_38",V="_clientName_hrf2p_45",U="_procedureName_hrf2p_51",q="_phone_hrf2p_57",G="_rating_hrf2p_63",J="_status_hrf2p_67",K="_approved_hrf2p_72",Q="_rejected_hrf2p_76",T="_pending_hrf2p_80",W="_text_hrf2p_84",X="_date_hrf2p_90",Y="_actions_hrf2p_96",a={reviews:L,header:P,title:D,empty:E,list:F,reviewCard:O,reviewHeader:A,clientName:V,procedureName:U,phone:q,rating:G,status:J,approved:K,rejected:Q,pending:T,text:W,date:X,actions:Y},re=()=>{const[_,x]=i.useState([]),[j,f]=i.useState(!0),[o,N]=i.useState("all"),[l,g]=i.useState({}),[y,w]=i.useState({});i.useEffect(()=>{d()},[o]);const d=async()=>{try{f(!0);const e=await h.getAll();let s=e;o==="approved"?s=e.filter(r=>r.approved===!0):o==="pending"&&(s=e.filter(r=>r.approved!==!0&&r.approved!==!1)),x(s);const p=await Promise.all(s.map(async r=>{const n=await I.get(r.id);return[r.id,n?.phone||""]})),c={};for(const[r,n]of p)n&&(c[r]=n);g(c)}catch(e){console.error("Ошибка загрузки отзывов:",e)}finally{f(!1)}},u=e=>{const s=typeof e=="number"?e:Number(e);return Number.isFinite(s)?Math.max(0,Math.min(5,Math.round(s))):0},S=async e=>{try{await h.update(e,{approved:!0}),await d()}catch(s){console.error("Ошибка одобрения отзыва:",s),alert("Ошибка при одобрении отзыва")}},R=async e=>{try{await h.update(e,{approved:!1}),await d()}catch(s){console.error("Ошибка отклонения отзыва:",s),alert("Ошибка при отклонении отзыва")}},C=async e=>{if(window.confirm("Вы уверены, что хотите удалить этот отзыв?"))try{await h.delete(e),await d()}catch(s){console.error("Ошибка удаления отзыва:",s),alert("Ошибка при удалении отзыва")}},b=async e=>{const s=l[e.id];if(!s){alert("Телефон не найден для этого отзыва");return}try{const c=(await M.getByPhone(s)||[]).some(r=>{const n=String(r.clientName||"").trim().toLowerCase()===String(e.clientName||"").trim().toLowerCase(),B=String(r.procedureId||"")===String(e.procedureId||"");return n&&B});w(r=>({...r,[e.id]:c})),c||alert("Не найдено совпадений в истории услуг по телефону/имени/процедуре.")}catch(p){console.error("Ошибка проверки отзыва:",p),alert("Ошибка при проверке")}},k=[{value:"all",label:"Все отзывы"},{value:"approved",label:"Одобренные"},{value:"pending",label:"Ожидающие модерации"}];return j?t.jsx(z,{variant:"admin"}):t.jsxs("div",{className:a.reviews,children:[t.jsxs("div",{className:a.header,children:[t.jsx("h1",{className:a.title,children:"Модерация отзывов"}),t.jsx(H,{value:o,onChange:e=>N(e.target.value),options:k})]}),_.length===0?t.jsx(v,{className:a.empty,children:t.jsx("p",{children:"Отзывов нет"})}):t.jsx("div",{className:a.list,children:_.map(e=>t.jsxs(v,{className:a.reviewCard,children:[t.jsxs("div",{className:a.reviewHeader,children:[t.jsxs("div",{children:[t.jsx("h3",{className:a.clientName,children:e.clientName}),t.jsx("p",{className:a.procedureName,children:e.procedureName}),l[e.id]&&t.jsxs("p",{className:a.phone,children:["Телефон: ",l[e.id]]}),t.jsxs("div",{className:a.rating,children:["⭐".repeat(u(e.rating)),"☆".repeat(5-u(e.rating))]})]}),t.jsxs("div",{className:a.status,children:[e.approved===!0?t.jsx("span",{className:a.approved,children:"✓ Одобрен"}):e.approved===!1?t.jsx("span",{className:a.rejected,children:"✗ Отклонен"}):t.jsx("span",{className:a.pending,children:"⏳ Ожидает"}),y[e.id]===!0&&t.jsx("span",{className:a.approved,children:" • Проверено"})]})]}),t.jsx("p",{className:a.text,children:e.text}),t.jsx("p",{className:a.date,children:new Date(e.date).toLocaleDateString("ru-RU")}),t.jsxs("div",{className:a.actions,children:[t.jsx(m,{size:"small",variant:"outline",onClick:()=>b(e),disabled:!l[e.id],children:"Проверить"}),e.approved!==!0&&t.jsx(m,{size:"small",onClick:()=>S(e.id),children:"Одобрить"}),e.approved!==!1&&t.jsx(m,{size:"small",variant:"secondary",onClick:()=>R(e.id),children:"Отклонить"}),t.jsx(m,{size:"small",variant:"secondary",onClick:()=>C(e.id),children:"Удалить"})]})]},e.id))})]})};export{re as default};
