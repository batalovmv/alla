import{o as m,q as L,j as t,R as H,B as _,D as B}from"./index-DKxZk2j6.js";import{r as i,L as I}from"./react-vendor-BQWX9zlF.js";import{C as x}from"./Card-BwajGH-R.js";import{S as D}from"./Select-u3bu_IL3.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-75UNovty.js";import"./form-vendor-BjD3cHyu.js";const E="_reviews_zt4b5_1",M="_header_zt4b5_5",O="_title_zt4b5_12",P="_loading_zt4b5_17",A="_empty_zt4b5_22",F="_seedHint_zt4b5_28",T="_seedLink_zt4b5_34",U="_list_zt4b5_44",V="_reviewCard_zt4b5_50",q="_reviewHeader_zt4b5_54",G="_clientName_zt4b5_61",J="_procedureName_zt4b5_67",K="_phone_zt4b5_73",Q="_rating_zt4b5_79",W="_status_zt4b5_83",X="_approved_zt4b5_88",Y="_rejected_zt4b5_92",Z="_pending_zt4b5_96",$="_text_zt4b5_100",ee="_date_zt4b5_106",te="_actions_zt4b5_112",s={reviews:E,header:M,title:O,loading:P,empty:A,seedHint:F,seedLink:T,list:U,reviewCard:V,reviewHeader:q,clientName:G,procedureName:J,phone:K,rating:Q,status:W,approved:X,rejected:Y,pending:Z,text:$,date:ee,actions:te},de=()=>{const[h,N]=i.useState([]),[j,u]=i.useState(!0),[o,f]=i.useState("all"),[d,g]=i.useState({}),[b,y]=i.useState({});i.useEffect(()=>{l()},[o]);const l=async()=>{try{u(!0);const e=await m.getAll();let a=e;o==="approved"?a=e.filter(r=>r.approved===!0):o==="pending"&&(a=e.filter(r=>r.approved!==!0&&r.approved!==!1)),N(a);const p=await Promise.all(a.map(async r=>{const n=await L.get(r.id);return[r.id,n?.phone||""]})),c={};for(const[r,n]of p)n&&(c[r]=n);g(c)}catch(e){console.error("Ошибка загрузки отзывов:",e)}finally{u(!1)}},v=e=>{const a=typeof e=="number"?e:Number(e);return Number.isFinite(a)?Math.max(0,Math.min(5,Math.round(a))):0},z=async e=>{try{await m.update(e,{approved:!0}),await l()}catch(a){console.error("Ошибка одобрения отзыва:",a),alert("Ошибка при одобрении отзыва")}},w=async e=>{try{await m.update(e,{approved:!1}),await l()}catch(a){console.error("Ошибка отклонения отзыва:",a),alert("Ошибка при отклонении отзыва")}},R=async e=>{if(window.confirm("Вы уверены, что хотите удалить этот отзыв?"))try{await m.delete(e),await l()}catch(a){console.error("Ошибка удаления отзыва:",a),alert("Ошибка при удалении отзыва")}},S=async e=>{const a=d[e.id];if(!a){alert("Телефон не найден для этого отзыва");return}try{const c=(await B.getByPhone(a)||[]).some(r=>{const n=String(r.clientName||"").trim().toLowerCase()===String(e.clientName||"").trim().toLowerCase(),k=String(r.procedureId||"")===String(e.procedureId||"");return n&&k});y(r=>({...r,[e.id]:c})),c||alert("Не найдено совпадений в истории услуг по телефону/имени/процедуре.")}catch(p){console.error("Ошибка проверки отзыва:",p),alert("Ошибка при проверке")}},C=[{value:"all",label:"Все отзывы"},{value:"approved",label:"Одобренные"},{value:"pending",label:"Ожидающие модерации"}];return j?t.jsx("div",{className:s.loading,children:"Загрузка..."}):t.jsxs("div",{className:s.reviews,children:[t.jsxs("div",{className:s.header,children:[t.jsx("h1",{className:s.title,children:"Модерация отзывов"}),t.jsx(D,{value:o,onChange:e=>f(e.target.value),options:C})]}),h.length===0?t.jsxs(x,{className:s.empty,children:[t.jsx("p",{children:"Отзывов нет"}),t.jsxs("p",{className:s.seedHint,children:["Для демонстрации можно создать тестовые данные в разделе"," ",t.jsx(I,{to:H.ADMIN_REPORTS,className:s.seedLink,children:"Отчёты"}),"."]})]}):t.jsx("div",{className:s.list,children:h.map(e=>t.jsxs(x,{className:s.reviewCard,children:[t.jsxs("div",{className:s.reviewHeader,children:[t.jsxs("div",{children:[t.jsx("h3",{className:s.clientName,children:e.clientName}),t.jsx("p",{className:s.procedureName,children:e.procedureName}),d[e.id]&&t.jsxs("p",{className:s.phone,children:["Телефон: ",d[e.id]]}),t.jsxs("div",{className:s.rating,children:["⭐".repeat(v(e.rating)),"☆".repeat(5-v(e.rating))]})]}),t.jsxs("div",{className:s.status,children:[e.approved===!0?t.jsx("span",{className:s.approved,children:"✓ Одобрен"}):e.approved===!1?t.jsx("span",{className:s.rejected,children:"✗ Отклонен"}):t.jsx("span",{className:s.pending,children:"⏳ Ожидает"}),b[e.id]===!0&&t.jsx("span",{className:s.approved,children:" • Проверено"})]})]}),t.jsx("p",{className:s.text,children:e.text}),t.jsx("p",{className:s.date,children:new Date(e.date).toLocaleDateString("ru-RU")}),t.jsxs("div",{className:s.actions,children:[t.jsx(_,{size:"small",variant:"outline",onClick:()=>S(e),disabled:!d[e.id],children:"Проверить"}),e.approved!==!0&&t.jsx(_,{size:"small",onClick:()=>z(e.id),children:"Одобрить"}),e.approved!==!1&&t.jsx(_,{size:"small",variant:"secondary",onClick:()=>w(e.id),children:"Отклонить"}),t.jsx(_,{size:"small",variant:"secondary",onClick:()=>R(e.id),children:"Удалить"})]})]},e.id))})]})};export{de as default};
