import{j as e,h as F,B as d,K as U,I as w,x as C,p as z}from"./index-Cruw93MP.js";import{r as y}from"./react-vendor-BQWX9zlF.js";import{f as P}from"./money-Dqo8ClJ3.js";import{u as A,b as $}from"./form-vendor-BjD3cHyu.js";import{T as B}from"./Textarea-BV4VaDkJ.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-DDhjV8tM.js";const E="_list_1u8yt_1",R="_item_1u8yt_7",L="_content_1u8yt_14",T="_image_1u8yt_21",K="_info_1u8yt_28",V="_name_1u8yt_32",M="_category_1u8yt_38",G="_price_1u8yt_44",H="_badge_1u8yt_51",J="_actions_1u8yt_62",O="_empty_1u8yt_67",c={list:E,item:R,content:L,image:T,info:K,name:V,category:M,price:G,badge:H,actions:J,empty:O},Q=({procedures:s,onEdit:h,onDelete:o})=>s.length===0?e.jsx(F,{className:c.empty,children:e.jsx("p",{children:"Процедур пока нет. Добавьте первую процедуру."})}):e.jsx("div",{className:c.list,children:s.map(a=>e.jsxs(F,{className:c.item,children:[e.jsxs("div",{className:c.content,children:[a.images&&a.images.length>0&&e.jsx("img",{src:a.images[0],alt:a.name,className:c.image}),e.jsxs("div",{className:c.info,children:[e.jsx("h3",{className:c.name,children:a.name}),e.jsx("p",{className:c.category,children:a.category}),e.jsx("p",{className:c.price,children:P(a.price)}),a.popular&&e.jsx("span",{className:c.badge,children:"Популярная"})]})]}),e.jsxs("div",{className:c.actions,children:[e.jsx(d,{size:"small",onClick:()=>h(a),children:"Редактировать"}),e.jsx(d,{size:"small",variant:"secondary",onClick:()=>o(a.id),children:"Удалить"})]})]},a.id))}),W="_imageUpload_2dtxu_1",X="_images_2dtxu_5",Y="_imageItem_2dtxu_12",Z="_removeButton_2dtxu_27",ee="_uploadButton_2dtxu_50",se="_hint_2dtxu_65",k={imageUpload:W,images:X,imageItem:Y,removeButton:Z,uploadButton:ee,hint:se},te=({value:s=[],onChange:h,maxImages:o=5,folder:a="procedures"})=>{const[g,i]=y.useState(!1),f=y.useRef(null),r=async _=>{const l=_.target.files;if(!l||l.length===0)return;const N=o-s.length,j=Array.from(l).slice(0,N);if(j.length===0){alert(`Максимум ${o} изображений`);return}i(!0);try{const v=await U.uploadMultipleImages(j,a);h([...s,...v])}catch(v){console.error("Ошибка загрузки изображений:",v),alert("Ошибка при загрузке изображений")}finally{i(!1),f.current&&(f.current.value="")}},x=_=>{const l=s.filter((N,j)=>j!==_);h(l)};return e.jsxs("div",{className:k.imageUpload,children:[e.jsxs("div",{className:k.images,children:[s.map((_,l)=>e.jsxs("div",{className:k.imageItem,children:[e.jsx("img",{src:_,alt:`Изображение ${l+1}`}),e.jsx("button",{type:"button",className:k.removeButton,onClick:()=>x(l),children:"×"})]},l)),s.length<o&&e.jsxs("div",{className:k.uploadButton,children:[e.jsx("input",{ref:f,type:"file",accept:"image/*",multiple:!0,onChange:r,disabled:g,style:{display:"none"}}),e.jsx(d,{type:"button",size:"small",onClick:()=>f.current?.click(),disabled:g,children:g?"Загрузка...":"+ Добавить"})]})]}),s.length>=o&&e.jsxs("p",{className:k.hint,children:["Достигнут лимит изображений (",o,")"]})]})},ae="_formContainer_6ep8q_1",ie="_card_6ep8q_5",ne="_header_6ep8q_9",re="_form_6ep8q_1",le="_row_6ep8q_27",oe="_field_6ep8q_33",ce="_label_6ep8q_39",de="_arrayItem_6ep8q_45",me="_checkbox_6ep8q_55",ue="_actions_6ep8q_65",n={formContainer:ae,card:ie,header:ne,form:re,row:le,field:oe,label:ce,arrayItem:de,checkbox:me,actions:ue},pe=({procedure:s,onClose:h,onSuccess:o})=>{const[a,g]=y.useState(!1),{register:i,handleSubmit:f,formState:{errors:r},control:x,setValue:_,watch:l}=A({defaultValues:{name:s?.name||"",category:s?.category||"",description:s?.description||"",fullDescription:s?.fullDescription||"",price:s?.price||0,duration:s?.duration||60,images:s?.images||[],indications:s?.indications?.map(t=>({value:t}))||[{value:""}],contraindications:s?.contraindications?.map(t=>({value:t}))||[{value:""}],popular:s?.popular||!1}}),{fields:N,append:j,remove:v}=$({control:x,name:"indications"}),{fields:m,append:u,remove:S}=$({control:x,name:"contraindications"}),q=l("images"),D=async t=>{g(!0);try{const p={name:t.name,category:t.category,description:t.description,fullDescription:t.fullDescription,price:Number(t.price),duration:Number(t.duration),images:t.images,indications:t.indications.map(b=>b.value).filter(b=>b.trim()),contraindications:t.contraindications.map(b=>b.value).filter(b=>b.trim()),popular:t.popular};s?await C.update(s.id,p):await C.create(p),o()}catch(p){console.error("Ошибка сохранения процедуры:",p),alert("Ошибка при сохранении процедуры")}finally{g(!1)}};return e.jsx("div",{className:n.formContainer,children:e.jsxs(F,{className:n.card,children:[e.jsxs("div",{className:n.header,children:[e.jsx("h2",{children:s?"Редактировать процедуру":"Добавить процедуру"}),e.jsx(d,{variant:"secondary",onClick:h,children:"×"})]}),e.jsxs("form",{onSubmit:f(D),className:n.form,children:[e.jsx(w,{label:"Название",...i("name",{required:"Название обязательно"}),error:r.name?.message}),e.jsx(w,{label:"Категория",...i("category",{required:"Категория обязательна"}),error:r.category?.message}),e.jsx(B,{label:"Краткое описание",rows:3,...i("description",{required:"Описание обязательно"}),error:r.description?.message}),e.jsx(B,{label:"Полное описание",rows:5,...i("fullDescription",{required:"Полное описание обязательно"}),error:r.fullDescription?.message}),e.jsxs("div",{className:n.row,children:[e.jsx(w,{label:"Цена (₸)",type:"number",...i("price",{required:"Цена обязательна",min:{value:0,message:"Цена должна быть положительной"},valueAsNumber:!0}),error:r.price?.message}),e.jsx(w,{label:"Длительность (минуты)",type:"number",...i("duration",{required:"Длительность обязательна",min:{value:1,message:"Минимум 1 минута"},valueAsNumber:!0}),error:r.duration?.message})]}),e.jsxs("div",{className:n.field,children:[e.jsx("label",{className:n.label,children:"Изображения"}),e.jsx(te,{value:q,onChange:t=>_("images",t),maxImages:5,folder:"procedures"})]}),e.jsxs("div",{className:n.field,children:[e.jsx("label",{className:n.label,children:"Показания"}),N.map((t,p)=>e.jsxs("div",{className:n.arrayItem,children:[e.jsx(w,{...i(`indications.${p}.value`),placeholder:"Показание"}),e.jsx(d,{type:"button",variant:"secondary",size:"small",onClick:()=>v(p),children:"Удалить"})]},t.id)),e.jsx(d,{type:"button",variant:"outline",size:"small",onClick:()=>j({value:""}),children:"+ Добавить показание"})]}),e.jsxs("div",{className:n.field,children:[e.jsx("label",{className:n.label,children:"Противопоказания"}),m.map((t,p)=>e.jsxs("div",{className:n.arrayItem,children:[e.jsx(w,{...i(`contraindications.${p}.value`),placeholder:"Противопоказание"}),e.jsx(d,{type:"button",variant:"secondary",size:"small",onClick:()=>S(p),children:"Удалить"})]},t.id)),e.jsx(d,{type:"button",variant:"outline",size:"small",onClick:()=>u({value:""}),children:"+ Добавить противопоказание"})]}),e.jsxs("div",{className:n.checkbox,children:[e.jsx("input",{type:"checkbox",id:"popular",...i("popular")}),e.jsx("label",{htmlFor:"popular",children:"Популярная процедура"})]}),e.jsxs("div",{className:n.actions,children:[e.jsx(d,{type:"submit",disabled:a,children:a?"Сохранение...":"Сохранить"}),e.jsx(d,{type:"button",variant:"secondary",onClick:h,children:"Отмена"})]})]})]})})},he="_procedures_jpmit_1",_e="_header_jpmit_5",ge="_title_jpmit_12",I={procedures:he,header:_e,title:ge},we=()=>{const[s,h]=y.useState([]),[o,a]=y.useState(!0),[g,i]=y.useState(!1),[f,r]=y.useState(null);y.useEffect(()=>{x()},[]);const x=async()=>{try{a(!0);const m=await C.getAll();h(m)}catch(m){console.error("Ошибка загрузки процедур:",m)}finally{a(!1)}},_=()=>{r(null),i(!0)},l=m=>{r(m),i(!0)},N=async m=>{try{const u=await C.getUsageCounts(m),S=u.bookings>0||u.reviews>0||u.serviceRecords>0,q=S?`Процедура используется:
- заявок: ${u.bookings}
- отзывов: ${u.reviews}
- записей услуг: ${u.serviceRecords}

Удаление НЕ удалит связанные документы каскадом, но часть экранов может потерять “связь” с процедурой.

Удалить всё равно?`:"Вы уверены, что хотите удалить эту процедуру?";if(!window.confirm(q)||S&&!window.confirm("Последнее подтверждение: точно удалить процедуру?"))return;await C.delete(m),await x()}catch(u){console.error("Ошибка удаления процедуры:",u),alert("Ошибка при удалении процедуры")}},j=()=>{i(!1),r(null)},v=()=>{i(!1),r(null),x()};return g?e.jsx(pe,{procedure:f,onClose:j,onSuccess:v}):e.jsxs("div",{className:I.procedures,children:[e.jsxs("div",{className:I.header,children:[e.jsx("h1",{className:I.title,children:"Управление процедурами"}),e.jsx(d,{onClick:_,children:"+ Добавить процедуру"})]}),o?e.jsx(z,{variant:"admin"}):e.jsx(Q,{procedures:s,onEdit:l,onDelete:N})]})};export{we as default};
