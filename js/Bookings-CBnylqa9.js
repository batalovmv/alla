const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index-DZ0XyFiP.js","js/react-vendor-BQWX9zlF.js","js/redux-vendor-B8TTZsxA.js","js/firebase-vendor-CGxEfUHl.js","js/form-vendor-BjD3cHyu.js","assets/index-B06b6obt.css"])))=>i.map(i=>d[i]);
import{t as j,p as w,j as s,R as L,B as d,_ as A}from"./index-DZ0XyFiP.js";import{r as m,L as B}from"./react-vendor-BQWX9zlF.js";import{C as N}from"./Card-DGzi4da3.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-CGxEfUHl.js";import"./form-vendor-BjD3cHyu.js";const D="_bookings_1mu75_1",E="_title_1mu75_5",H="_tabs_1mu75_10",b="_tab_1mu75_10",z="_tabActive_1mu75_39",V="_loading_1mu75_64",$="_empty_1mu75_69",F="_seedHint_1mu75_75",P="_seedLink_1mu75_81",T="_list_1mu75_91",O="_bookingCard_1mu75_97",U="_bookingHeader_1mu75_101",k="_clientName_1mu75_110",J="_procedureName_1mu75_116",M="_status_1mu75_122",q="_awaiting_1mu75_135",G="_completed_1mu75_140",K="_cancelled_1mu75_145",Q="_bookingInfo_1mu75_150",W="_infoRow_1mu75_154",X="_label_1mu75_160",Y="_phone_1mu75_166",Z="_comment_1mu75_175",ee="_actions_1mu75_187",a={bookings:D,title:E,tabs:H,tab:b,tabActive:z,loading:V,empty:$,seedHint:F,seedLink:P,list:T,bookingCard:O,bookingHeader:U,clientName:k,procedureName:J,status:M,new:"_new_1mu75_129",awaiting:q,completed:G,cancelled:K,bookingInfo:Q,infoRow:W,label:X,phone:Y,comment:Z,actions:ee},ie=()=>{const[u,v]=m.useState([]),[f,h]=m.useState(!0),[_,R]=m.useState("new");m.useEffect(()=>{x()},[_]);const x=async()=>{try{h(!0);let t=await j.getAll();const n=await w.getAll();t=t.map(c=>{if(!c.procedureName&&c.procedureId){const o=n.find(l=>l.id===c.procedureId);if(o)return{...c,procedureName:o.name}}return c}),t=t.filter(c=>(c.status==="processed"?"awaiting":c.status)===_),v(t)}catch(e){console.error("Ошибка загрузки заявок:",e)}finally{h(!1)}},r=async(e,t)=>{try{if(await j.update(e,{status:t}),t==="completed"){const n=u.find(c=>c.id===e);n&&await S(n)}await x()}catch(n){console.error("Ошибка обновления статуса:",n),alert("Ошибка при обновлении статуса")}},S=async e=>{try{const{clientsService:t,serviceRecordsService:n}=await A(async()=>{const{clientsService:i,serviceRecordsService:p}=await import("./index-DZ0XyFiP.js").then(I=>I.J);return{clientsService:i,serviceRecordsService:p}},__vite__mapDeps([0,1,2,3,4,5])),o=(await w.getAll()).find(i=>i.id===e.procedureId);let l=await t.getByPhone(e.phone);if(!l){const i=await t.create({phone:e.phone,name:e.name,email:e.email,totalVisits:0});l=await t.get(i)}if(l){const i=new Date(e.desiredDate);await n.create({clientId:l.id,clientPhone:e.phone,clientName:e.name,procedureId:e.procedureId,procedureName:e.procedureName,date:i,price:o?.price??0,notes:e.comment||void 0,bookingId:e.id});const p=(l.totalVisits||0)+1;await t.update(l.id,{totalVisits:p,lastVisit:i})}}catch(t){console.error("Ошибка создания записи об услуге:",t)}},g=[{value:"new",label:"Новые"},{value:"awaiting",label:"Ожидание"},{value:"completed",label:"Выполненные"},{value:"cancelled",label:"Отмененные"}],y=e=>{switch(e){case"new":return"Новая";case"awaiting":return"Ожидание";case"completed":return"Выполнена";case"cancelled":return"Отменена";default:return e}},C=e=>{switch(e){case"new":return a.new;case"awaiting":return a.awaiting;case"completed":return a.completed;case"cancelled":return a.cancelled;default:return""}};return f?s.jsx("div",{className:a.loading,children:"Загрузка..."}):s.jsxs("div",{className:a.bookings,children:[s.jsx("h1",{className:a.title,children:"Заявки на запись"}),s.jsx("div",{className:a.tabs,children:g.map(e=>s.jsx("button",{className:`${a.tab} ${_===e.value?a.tabActive:""}`,onClick:()=>R(e.value),children:e.label},e.value))}),u.length===0?s.jsxs(N,{className:a.empty,children:[s.jsx("p",{children:"Заявок нет"}),s.jsxs("p",{className:a.seedHint,children:["Для демонстрации можно создать тестовые данные в разделе"," ",s.jsx(B,{to:L.ADMIN_REPORTS,className:a.seedLink,children:"Отчёты"}),"."]})]}):s.jsx("div",{className:a.list,children:u.map(e=>s.jsxs(N,{className:a.bookingCard,children:[s.jsxs("div",{className:a.bookingHeader,children:[s.jsxs("div",{children:[s.jsx("h3",{className:a.clientName,children:e.name}),s.jsx("p",{className:a.procedureName,children:e.procedureName})]}),s.jsx("span",{className:`${a.status} ${C(e.status)}`,children:y(e.status)})]}),s.jsxs("div",{className:a.bookingInfo,children:[s.jsxs("div",{className:a.infoRow,children:[s.jsx("span",{className:a.label,children:"Телефон:"}),s.jsx("a",{href:`tel:${e.phone}`,className:a.phone,children:e.phone})]}),e.email&&s.jsxs("div",{className:a.infoRow,children:[s.jsx("span",{className:a.label,children:"Email:"}),s.jsx("a",{href:`mailto:${e.email}`,children:e.email})]}),s.jsxs("div",{className:a.infoRow,children:[s.jsx("span",{className:a.label,children:"Желаемая дата:"}),s.jsx("span",{children:new Date(e.desiredDate).toLocaleDateString("ru-RU")})]}),s.jsxs("div",{className:a.infoRow,children:[s.jsx("span",{className:a.label,children:"Желаемое время:"}),s.jsx("span",{children:e.desiredTime})]}),e.comment&&s.jsxs("div",{className:a.comment,children:[s.jsx("span",{className:a.label,children:"Комментарий:"}),s.jsx("p",{children:e.comment})]}),s.jsxs("div",{className:a.infoRow,children:[s.jsx("span",{className:a.label,children:"Дата заявки:"}),s.jsx("span",{children:new Date(e.createdAt).toLocaleString("ru-RU")})]})]}),s.jsxs("div",{className:a.actions,children:[e.status==="new"&&s.jsxs(s.Fragment,{children:[s.jsx(d,{size:"small",onClick:()=>r(e.id,"awaiting"),children:"В ожидание"}),s.jsx(d,{size:"small",variant:"secondary",onClick:()=>r(e.id,"cancelled"),children:"Отменить"})]}),e.status==="awaiting"&&s.jsxs(s.Fragment,{children:[s.jsx(d,{size:"small",onClick:()=>r(e.id,"completed"),children:"Выполнена"}),s.jsx(d,{size:"small",variant:"secondary",onClick:()=>r(e.id,"cancelled"),children:"Отменить"}),s.jsx(d,{size:"small",variant:"outline",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"})]}),e.status==="completed"&&s.jsx(d,{size:"small",variant:"outline",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"}),e.status==="cancelled"&&s.jsx(d,{size:"small",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"})]})]},e.id))})]})};export{ie as default};
