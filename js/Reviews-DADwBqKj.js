import{a as y,j as e,I as z,B as J,u as U,h as E,S as x,i as Y,c as F,d as V}from"./index-DTpEtvuZ.js";import{R as Q,r as n}from"./react-vendor-BQWX9zlF.js";import{b as W,u as X,s as Z,i as ee,a as se}from"./useInView-DNMj0Zz_.js";import{S as B}from"./Select-B3cAiPFK.js";import{u as te,C as q}from"./form-vendor-BjD3cHyu.js";import{v as re,M as ae}from"./MaskedPhoneInput-eS1fAAou.js";import{T as ne}from"./Textarea-Mp-xS5Mj.js";import{S as ie}from"./SEO-D5RDqzE3.js";import{R as oe}from"./Reveal-VNHfsU7_.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-mpaoXh-M.js";const O="cosmetology_reviews",ce="1.0",le=()=>{try{const i=localStorage.getItem(O);if(!i)return[];const a=JSON.parse(i);return a.version!==ce?a.reviews||[]:a.reviews||[]}catch(i){return console.error("Ошибка загрузки отзывов из localStorage:",i),[]}},de=i=>{const a=d=>{if(d.key===O&&d.newValue)try{const u=JSON.parse(d.newValue);i(u.reviews||[])}catch(u){console.error("Ошибка синхронизации отзывов:",u)}};return window.addEventListener("storage",a),()=>{window.removeEventListener("storage",a)}},ue="_formContainer_137s1_1",me="_title_137s1_9",he="_form_137s1_1",ve="_ratingSection_137s1_22",ge="_ratingLabel_137s1_28",pe="_required_137s1_34",_e="_ratingStars_137s1_39",xe="_starLabel_137s1_46",fe="_starInput_137s1_59",we="_star_137s1_46",je="_errorMessage_137s1_79",Ne="_submitButton_137s1_85",l={formContainer:ue,title:me,form:he,ratingSection:ve,ratingLabel:ge,required:pe,ratingStars:_e,starLabel:xe,starInput:fe,star:we,errorMessage:je,submitButton:Ne},Se=({onSubmit:i,isSubmitting:a=!1})=>{const{items:d}=y(r=>r.procedures),{register:u,handleSubmit:f,control:m,formState:{errors:o},reset:w}=te({defaultValues:{rating:5}}),j=n.useMemo(()=>d.map(r=>({value:r.id,label:r.name})),[d]),p=r=>{i(r),w()};return e.jsxs("div",{className:l.formContainer,children:[e.jsx("h3",{className:l.title,children:"Оставить отзыв"}),e.jsxs("form",{onSubmit:f(p),className:l.form,children:[e.jsx(z,{label:"Ваше имя",...u("clientName",{required:"Имя обязательно для заполнения",minLength:{value:2,message:"Имя должно содержать минимум 2 символа"},maxLength:{value:50,message:"Имя не должно превышать 50 символов"}}),error:o.clientName?.message}),e.jsx(q,{name:"phone",control:m,rules:{required:"Телефон обязателен для подтверждения",validate:r=>re(String(r||""))||"Неверный формат телефона"},render:({field:r})=>e.jsx(ae,{label:"Телефон (не публикуется, нужен для подтверждения)",inputMode:"tel",autoComplete:"tel",value:String(r.value||""),onChange:_=>r.onChange(_),onBlur:r.onBlur,required:!0,error:o.phone?.message})}),e.jsx(q,{name:"procedureId",control:m,rules:{required:"Выберите процедуру"},render:({field:r})=>e.jsx(B,{label:"Процедура",options:j,...r,error:o.procedureId?.message})}),e.jsxs("div",{className:l.ratingSection,children:[e.jsxs("label",{className:l.ratingLabel,children:["Оценка ",e.jsx("span",{className:l.required,children:"*"})]}),e.jsx("div",{className:l.ratingStars,children:[5,4,3,2,1].map(r=>e.jsxs("label",{className:l.starLabel,children:[e.jsx("input",{type:"radio",value:r,...u("rating",{required:"Выберите оценку"}),className:l.starInput}),e.jsx("span",{className:l.star,children:"⭐"})]},r))}),o.rating&&e.jsx("span",{className:l.errorMessage,children:o.rating.message})]}),e.jsx(ne,{label:"Ваш отзыв",...u("text",{required:"Отзыв обязателен для заполнения",minLength:{value:10,message:"Отзыв должен содержать минимум 10 символов"},maxLength:{value:1e3,message:"Отзыв не должен превышать 1000 символов"}}),error:o.text?.message,rows:5}),e.jsx(J,{type:"submit",size:"large",disabled:a,className:l.submitButton,children:a?"Отправка...":"Отправить отзыв"})]})]})},Re=Q.memo(Se),be="_reviews_2uvf8_1",ye="_container_2uvf8_6",Me="_title_2uvf8_11",Ce="_header_2uvf8_19",Ie="_ratingSection_2uvf8_28",Le="_averageRating_2uvf8_33",Ae="_ratingValue_2uvf8_40",Pe="_stars_2uvf8_48",Te="_ratingText_2uvf8_53",Ee="_filter_2uvf8_59",Fe="_reviewsGrid_2uvf8_65",Ve="_reviewCard_2uvf8_71",qe="_reviewHeader_2uvf8_78",Be="_reviewAuthor_2uvf8_85",Oe="_authorPhoto_2uvf8_92",$e="_authorPlaceholder_2uvf8_99",ke="_authorName_2uvf8_112",Ge="_procedureName_2uvf8_119",He="_reviewRating_2uvf8_125",Ke="_reviewText_2uvf8_131",De="_reviewDate_2uvf8_138",ze="_empty_2uvf8_144",t={reviews:be,container:ye,title:Me,header:Ce,ratingSection:Ie,averageRating:Le,ratingValue:Ae,stars:Pe,ratingText:Te,filter:Ee,reviewsGrid:Fe,reviewCard:Ve,reviewHeader:qe,reviewAuthor:Be,authorPhoto:Oe,authorPlaceholder:$e,authorName:ke,procedureName:Ge,reviewRating:He,reviewText:Ke,reviewDate:De,empty:ze},ns=()=>{const i=U(),{items:a,averageRating:d,lastFetched:u,loading:f}=y(s=>s.reviews),{items:m}=y(s=>s.procedures),[o,w]=n.useState(""),[j,p]=n.useState(!1),[r,_]=n.useState(null),M=!0,C=n.useRef("");n.useEffect(()=>{C.current=a.map(s=>`${s.id}:${s.approved===!0?"1":s.approved===!1?"0":"u"}`).join("|")},[a]),n.useEffect(()=>{(async()=>{i(F(!0));const c=le(),R=3*60*1e3,D=[...a.length===0||ee(u,R)?await se():[],...c],T=Array.from(new Map(D.map(v=>[v.id,v])).values());T.map(v=>`${v.id}:${v.approved===!0?"1":v.approved===!1?"0":"u"}`).join("|")!==C.current&&i(V(T)),i(F(!1))})()},[i,M]),n.useEffect(()=>de(c=>{i(V(c))}),[i]);const $=n.useMemo(()=>[{value:"",label:"Все процедуры"},...m.map(s=>({value:s.id,label:s.name}))],[m]),g=n.useMemo(()=>a.filter(s=>s.approved===!0),[a]),h=n.useMemo(()=>o?g.filter(s=>s.procedureId===o):g,[g,o]),I=W(f&&a.length===0,160),[N,L]=n.useState(6),{ref:k,inView:S}=X({once:!1,rootMargin:"700px 0px"}),A=n.useRef(!1);n.useEffect(()=>{L(6)},[o]),n.useEffect(()=>{const s=A.current;A.current=S,!(!S||s)&&L(c=>Math.min(c+4,h.length))},[S,h.length]);const G=n.useMemo(()=>h.slice(0,N),[h,N]),H=n.useCallback(async s=>{p(!0),_(null);const R=m.find(P=>P.id===s.procedureId)?.name||"Неизвестная процедура",b=await Z({clientName:s.clientName,phone:s.phone,procedureId:s.procedureId,procedureName:R,rating:s.rating,text:s.text});b.success,_(b.message),p(!1)},[i,m,a]),K=s=>{const c=Math.max(0,Math.min(5,Number.isFinite(s)?s:0));return"⭐".repeat(c)+"☆".repeat(5-c)};return e.jsxs(e.Fragment,{children:[e.jsx(ie,{title:"Отзывы",description:"Отзывы наших клиентов о косметологических процедурах. Реальные истории и результаты.",keywords:"отзывы косметология, отзывы клиентов, косметологические процедуры отзывы"}),e.jsx("div",{className:t.reviews,children:e.jsxs("div",{className:t.container,children:[e.jsx("h1",{className:t.title,children:"Отзывы клиентов"}),r&&e.jsx(E,{className:t.reviewCard,children:e.jsx("p",{children:r})}),e.jsx(Re,{onSubmit:H,isSubmitting:j}),I?e.jsxs("div",{className:t.header,children:[e.jsx("div",{className:t.ratingSection,children:e.jsxs("div",{className:t.averageRating,children:[e.jsx(x,{variant:"text",height:26,width:56}),e.jsx("div",{className:t.stars,style:{marginTop:6},children:e.jsx(x,{variant:"text",height:16,width:120})}),e.jsx("p",{className:t.ratingText,style:{marginTop:8},children:e.jsx(x,{variant:"text",height:12,width:180})})]})}),e.jsx("div",{className:t.filter,children:e.jsx(x,{height:56,radius:12})})]}):g.length>0?e.jsxs("div",{className:t.header,children:[e.jsx("div",{className:t.ratingSection,children:e.jsxs("div",{className:t.averageRating,children:[e.jsx("span",{className:t.ratingValue,children:d.toFixed(1)}),e.jsxs("div",{className:t.stars,children:["⭐".repeat(Math.max(0,Math.min(5,Math.round(d)))),"☆".repeat(5-Math.max(0,Math.min(5,Math.round(d))))]}),e.jsxs("p",{className:t.ratingText,children:["На основе ",g.length," отзывов"]})]})}),e.jsx("div",{className:t.filter,children:e.jsx(B,{label:"Фильтр по процедуре",options:$,value:o,onChange:s=>w(s.target.value)})})]}):null,I?e.jsx("div",{className:t.reviewsGrid,children:Array.from({length:6}).map((s,c)=>e.jsx(Y,{},c))}):h.length>0?e.jsxs("div",{className:t.reviewsGrid,children:[G.map((s,c)=>e.jsx(oe,{delayMs:Math.min(c*22,180),children:e.jsxs(E,{className:t.reviewCard,children:[e.jsxs("div",{className:t.reviewHeader,children:[e.jsxs("div",{className:t.reviewAuthor,children:[s.clientPhoto?e.jsx("img",{src:s.clientPhoto,alt:s.clientName,className:t.authorPhoto,loading:"lazy"}):e.jsx("div",{className:t.authorPlaceholder,children:s.clientName.charAt(0).toUpperCase()}),e.jsxs("div",{children:[e.jsx("h3",{className:t.authorName,children:s.clientName}),e.jsx("p",{className:t.procedureName,children:s.procedureName})]})]}),e.jsx("div",{className:t.reviewRating,children:K(s.rating)})]}),e.jsx("p",{className:t.reviewText,children:s.text}),e.jsx("p",{className:t.reviewDate,children:new Date(s.date).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})})]})},s.id)),N<h.length&&e.jsx("div",{ref:k,style:{height:1,width:"100%",gridColumn:"1 / -1"},"aria-hidden":"true"})]}):e.jsx("div",{className:t.empty,children:e.jsx("p",{children:o?"Нет отзывов по выбранной процедуре":"Отзывов пока нет"})})]})})]})};export{ns as default};
