import{j as e,h as z,B as l,U as A,I as N,F as j,p as D}from"./index-TBdT1FO9.js";import{r as x}from"./react-vendor-BQWX9zlF.js";import{f as R}from"./money-Dqo8ClJ3.js";import{u as P,b as B}from"./form-vendor-BjD3cHyu.js";import{T as U}from"./Textarea-BbF-aBaa.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-mpaoXh-M.js";const E="_list_1u8yt_1",L="_item_1u8yt_7",T="_content_1u8yt_14",H="_image_1u8yt_21",V="_info_1u8yt_28",K="_name_1u8yt_32",M="_category_1u8yt_38",W="_price_1u8yt_44",G="_badge_1u8yt_51",J="_actions_1u8yt_62",O="_empty_1u8yt_67",m={list:E,item:L,content:T,image:H,info:V,name:K,category:M,price:W,badge:G,actions:J,empty:O},Q=({procedures:t,onEdit:p,onDelete:d,onRestore:_,onHardDelete:u,showArchived:n=!1})=>t.length===0?e.jsx(z,{className:m.empty,children:e.jsx("p",{children:"Процедур пока нет. Добавьте первую процедуру."})}):e.jsx("div",{className:m.list,children:t.map(i=>e.jsxs(z,{className:m.item,children:[e.jsxs("div",{className:m.content,children:[i.images&&i.images.length>0&&e.jsx("img",{src:i.images[0],alt:i.name,className:m.image}),e.jsxs("div",{className:m.info,children:[e.jsx("h3",{className:m.name,children:i.name}),e.jsx("p",{className:m.category,children:i.category}),e.jsx("p",{className:m.price,children:R(i.price)}),i.popular&&e.jsx("span",{className:m.badge,children:"Популярная"})]})]}),e.jsxs("div",{className:m.actions,children:[e.jsx(l,{size:"small",onClick:()=>p(i),children:"Редактировать"}),n?e.jsxs(e.Fragment,{children:[e.jsx(l,{size:"small",onClick:()=>_?.(i.id),children:"Восстановить"}),e.jsx(l,{size:"small",variant:"secondary",onClick:()=>u?.(i.id),children:"Удалить навсегда"})]}):e.jsx(l,{size:"small",variant:"secondary",onClick:()=>d(i.id),children:"Архивировать"})]})]},i.id))}),X="_imageUpload_2dtxu_1",Y="_images_2dtxu_5",Z="_imageItem_2dtxu_12",ee="_removeButton_2dtxu_27",se="_uploadButton_2dtxu_50",ae="_hint_2dtxu_65",w={imageUpload:X,images:Y,imageItem:Z,removeButton:ee,uploadButton:se,hint:ae},te=({value:t=[],onChange:p,maxImages:d=5,folder:_="procedures"})=>{const[u,n]=x.useState(!1),i=x.useRef(null),c=async h=>{const r=h.target.files;if(!r||r.length===0)return;const b=d-t.length,y=Array.from(r).slice(0,b);if(y.length===0){alert(`Максимум ${d} изображений`);return}n(!0);try{const v=await A.uploadMultipleImages(y,_);p([...t,...v])}catch(v){console.error("Ошибка загрузки изображений:",v),alert("Ошибка при загрузке изображений")}finally{n(!1),i.current&&(i.current.value="")}},g=h=>{const r=t.filter((b,y)=>y!==h);p(r)};return e.jsxs("div",{className:w.imageUpload,children:[e.jsxs("div",{className:w.images,children:[t.map((h,r)=>e.jsxs("div",{className:w.imageItem,children:[e.jsx("img",{src:h,alt:`Изображение ${r+1}`}),e.jsx("button",{type:"button",className:w.removeButton,onClick:()=>g(r),children:"×"})]},r)),t.length<d&&e.jsxs("div",{className:w.uploadButton,children:[e.jsx("input",{ref:i,type:"file",accept:"image/*",multiple:!0,onChange:c,disabled:u,style:{display:"none"}}),e.jsx(l,{type:"button",size:"small",onClick:()=>i.current?.click(),disabled:u,children:u?"Загрузка...":"+ Добавить"})]})]}),t.length>=d&&e.jsxs("p",{className:w.hint,children:["Достигнут лимит изображений (",d,")"]})]})},ie="_formContainer_6ep8q_1",ne="_card_6ep8q_5",re="_header_6ep8q_9",oe="_form_6ep8q_1",le="_row_6ep8q_27",ce="_field_6ep8q_33",de="_label_6ep8q_39",me="_arrayItem_6ep8q_45",ue="_checkbox_6ep8q_55",he="_actions_6ep8q_65",o={formContainer:ie,card:ne,header:re,form:oe,row:le,field:ce,label:de,arrayItem:me,checkbox:ue,actions:he},pe=({procedure:t,onClose:p,onSuccess:d})=>{const[_,u]=x.useState(!1),{register:n,handleSubmit:i,formState:{errors:c},control:g,setValue:h,watch:r}=P({defaultValues:{name:t?.name||"",category:t?.category||"",description:t?.description||"",fullDescription:t?.fullDescription||"",price:t?.price||0,duration:t?.duration||60,images:t?.images||[],indications:t?.indications?.map(s=>({value:s}))||[{value:""}],contraindications:t?.contraindications?.map(s=>({value:s}))||[{value:""}],popular:t?.popular||!1}}),{fields:b,append:y,remove:v}=B({control:g,name:"indications"}),{fields:k,append:C,remove:S}=B({control:g,name:"contraindications"}),q=r("images"),$=async s=>{u(!0);try{const a={name:s.name,category:s.category,description:s.description,fullDescription:s.fullDescription,price:Number(s.price),duration:Number(s.duration),images:s.images,indications:s.indications.map(f=>f.value).filter(f=>f.trim()),contraindications:s.contraindications.map(f=>f.value).filter(f=>f.trim()),popular:s.popular};t?await j.update(t.id,a):await j.create(a),d()}catch(a){console.error("Ошибка сохранения процедуры:",a),alert("Ошибка при сохранении процедуры")}finally{u(!1)}};return e.jsx("div",{className:o.formContainer,children:e.jsxs(z,{className:o.card,children:[e.jsxs("div",{className:o.header,children:[e.jsx("h2",{children:t?"Редактировать процедуру":"Добавить процедуру"}),e.jsx(l,{variant:"secondary",onClick:p,children:"×"})]}),e.jsxs("form",{onSubmit:i($),className:o.form,children:[e.jsx(N,{label:"Название",...n("name",{required:"Название обязательно"}),error:c.name?.message}),e.jsx(N,{label:"Категория",...n("category",{required:"Категория обязательна"}),error:c.category?.message}),e.jsx(U,{label:"Краткое описание",rows:3,...n("description",{required:"Описание обязательно"}),error:c.description?.message}),e.jsx(U,{label:"Полное описание",rows:5,...n("fullDescription",{required:"Полное описание обязательно"}),error:c.fullDescription?.message}),e.jsxs("div",{className:o.row,children:[e.jsx(N,{label:"Цена (₸)",type:"number",...n("price",{required:"Цена обязательна",min:{value:0,message:"Цена должна быть положительной"},valueAsNumber:!0}),error:c.price?.message}),e.jsx(N,{label:"Длительность (минуты)",type:"number",...n("duration",{required:"Длительность обязательна",min:{value:1,message:"Минимум 1 минута"},valueAsNumber:!0}),error:c.duration?.message})]}),e.jsxs("div",{className:o.field,children:[e.jsx("label",{className:o.label,children:"Изображения"}),e.jsx(te,{value:q,onChange:s=>h("images",s),maxImages:5,folder:"procedures"})]}),e.jsxs("div",{className:o.field,children:[e.jsx("label",{className:o.label,children:"Показания"}),b.map((s,a)=>e.jsxs("div",{className:o.arrayItem,children:[e.jsx(N,{...n(`indications.${a}.value`),placeholder:"Показание"}),e.jsx(l,{type:"button",variant:"secondary",size:"small",onClick:()=>v(a),children:"Удалить"})]},s.id)),e.jsx(l,{type:"button",variant:"outline",size:"small",onClick:()=>y({value:""}),children:"+ Добавить показание"})]}),e.jsxs("div",{className:o.field,children:[e.jsx("label",{className:o.label,children:"Противопоказания"}),k.map((s,a)=>e.jsxs("div",{className:o.arrayItem,children:[e.jsx(N,{...n(`contraindications.${a}.value`),placeholder:"Противопоказание"}),e.jsx(l,{type:"button",variant:"secondary",size:"small",onClick:()=>S(a),children:"Удалить"})]},s.id)),e.jsx(l,{type:"button",variant:"outline",size:"small",onClick:()=>C({value:""}),children:"+ Добавить противопоказание"})]}),e.jsxs("div",{className:o.checkbox,children:[e.jsx("input",{type:"checkbox",id:"popular",...n("popular")}),e.jsx("label",{htmlFor:"popular",children:"Популярная процедура"})]}),e.jsxs("div",{className:o.actions,children:[e.jsx(l,{type:"submit",disabled:_,children:_?"Сохранение...":"Сохранить"}),e.jsx(l,{type:"button",variant:"secondary",onClick:p,children:"Отмена"})]})]})]})})},_e="_procedures_jpmit_1",ge="_header_jpmit_5",fe="_title_jpmit_12",I={procedures:_e,header:ge,title:fe},ke=()=>{const[t,p]=x.useState([]),[d,_]=x.useState(!0),[u,n]=x.useState(!1),[i,c]=x.useState(null),[g,h]=x.useState(!1);x.useEffect(()=>{r()},[]);const r=async()=>{try{_(!0);const s=await j.getAll({includeArchived:!0});p(s)}catch(s){console.error("Ошибка загрузки процедур:",s)}finally{_(!1)}},b=()=>{c(null),n(!0)},y=s=>{c(s),n(!0)},v=async s=>{try{const a=await j.getUsageCounts(s),F=a.bookings>0||a.reviews>0||a.serviceRecords>0?`Процедура используется:
- заявок: ${a.bookings}
- отзывов: ${a.reviews}
- записей услуг: ${a.serviceRecords}

Рекомендуем архивировать, чтобы не терять историю.

Архивировать процедуру?`:"Архивировать процедуру? (она пропадёт с сайта и из списка выбора)";if(!window.confirm(F))return;await j.archive(s),await r()}catch(a){console.error("Ошибка архивирования процедуры:",a),alert("Ошибка при архивировании процедуры")}},k=async s=>{if(window.confirm("Восстановить процедуру из архива?"))try{await j.restore(s),await r()}catch(a){console.error("Ошибка восстановления процедуры:",a),alert("Ошибка при восстановлении процедуры")}},C=async s=>{try{const a=await j.getUsageCounts(s),F=a.bookings>0||a.reviews>0||a.serviceRecords>0?`ВНИМАНИЕ: процедура используется:
- заявок: ${a.bookings}
- отзывов: ${a.reviews}
- записей услуг: ${a.serviceRecords}

Полное удаление может ухудшить читаемость истории/отчётов.

Удалить навсегда?`:"Удалить процедуру НАВСЕГДА?";if(!window.confirm(F)||!window.confirm("Последнее подтверждение: удалить навсегда?"))return;await j.delete(s),await r()}catch(a){console.error("Ошибка удаления процедуры:",a),alert("Ошибка при удалении процедуры")}},S=()=>{n(!1),c(null)},q=()=>{n(!1),c(null),r()};if(u)return e.jsx(pe,{procedure:i,onClose:S,onSuccess:q});const $=t.filter(s=>g?s.archived===!0:s.archived!==!0);return e.jsxs("div",{className:I.procedures,children:[e.jsxs("div",{className:I.header,children:[e.jsx("h1",{className:I.title,children:"Управление процедурами"}),e.jsx(l,{onClick:b,children:"+ Добавить процедуру"})]}),e.jsxs("div",{style:{display:"flex",gap:10,marginBottom:12,flexWrap:"wrap"},children:[e.jsx(l,{size:"small",variant:g?"outline":"secondary",onClick:()=>h(!1),children:"Активные"}),e.jsx(l,{size:"small",variant:g?"secondary":"outline",onClick:()=>h(!0),children:"Архив"})]}),d?e.jsx(D,{variant:"admin"}):e.jsx(Q,{procedures:$,onEdit:y,onDelete:v,onRestore:k,onHardDelete:C,showArchived:g})]})};export{ke as default};
