import{a1 as _,W as j,G as F,j as e,p as G,B as a,R as C,h as d,I as g}from"./index-CQRSAtSo.js";import{e as H,b as O,r as i}from"./react-vendor-BQWX9zlF.js";import{u as $,C as B}from"./form-vendor-BjD3cHyu.js";import{T as M}from"./Textarea-C8naNVC6.js";import{S as U}from"./Select-roJkvW3W.js";import{f}from"./money-Dqo8ClJ3.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-mpaoXh-M.js";const q="_history_1scv0_1",z="_header_1scv0_5",K="_title_1scv0_20",W="_error_1scv0_27",J="_clientInfo_1scv0_37",Q="_infoGrid_1scv0_42",X="_label_1scv0_54",Y="_formCard_1scv0_69",Z="_form_1scv0_69",ee="_formActions_1scv0_85",se="_records_1scv0_91",re="_empty_1scv0_95",te="_recordsList_1scv0_102",ce="_recordCard_1scv0_107",ae="_recordHeader_1scv0_111",ie="_recordDate_1scv0_123",oe="_recordPrice_1scv0_129",ne="_recordNotes_1scv0_135",le="_recordActions_1scv0_143",r={history:q,header:z,title:K,error:W,clientInfo:J,infoGrid:Q,label:X,formCard:Y,form:Z,formActions:ee,records:se,empty:re,recordsList:te,recordCard:ce,recordHeader:ae,recordDate:ie,recordPrice:oe,recordNotes:ne,recordActions:le},fe=()=>{const{clientId:o}=H(),v=O(),[t,D]=i.useState(null),[m,I]=i.useState([]),[N,w]=i.useState([]),[A,y]=i.useState(!0),[h,p]=i.useState(!1),{register:u,handleSubmit:V,control:L,formState:{errors:n},reset:S}=$({defaultValues:{date:new Date().toISOString().split("T")[0]}});i.useEffect(()=>{o&&x()},[o]);const x=async()=>{try{if(y(!0),o){const[s,c,l]=await Promise.all([_.get(o),j.getByClientId(o),F.getAll()]);D(s),I(c),w(l)}}catch(s){console.error("Ошибка загрузки данных:",s)}finally{y(!1)}},P=async s=>{if(t)try{const c=N.find(k=>k.id===s.procedureId);if(!c){alert("Процедура не найдена");return}const l=new Date(s.date);await j.create({clientId:t.id,clientPhone:t.phone,clientName:t.name,procedureId:c.id,procedureName:c.name,date:l,price:s.price?parseFloat(s.price):c.price,notes:s.notes||void 0});const R=(t.totalVisits||0)+1;await _.update(t.id,{totalVisits:R,lastVisit:l}),S(),p(!1),await x()}catch(c){console.error("Ошибка создания записи:",c),alert("Ошибка при создании записи")}},T=async s=>{if(confirm("Удалить эту запись?"))try{if(await j.delete(s),t){const c=Math.max((t.totalVisits||0)-1,0);await _.update(t.id,{totalVisits:c})}await x()}catch(c){console.error("Ошибка удаления записи:",c),alert("Ошибка при удалении записи")}},E=N.map(s=>({value:s.id,label:`${s.name} - ${f(s.price)}`})),b=m.reduce((s,c)=>s+(c.price||0),0);return A?e.jsx(G,{variant:"admin"}):t?e.jsxs("div",{className:r.history,children:[e.jsxs("div",{className:r.header,children:[e.jsxs("div",{children:[e.jsx(a,{variant:"outline",onClick:()=>v(C.ADMIN_CLIENTS),children:"← Назад к списку"}),e.jsxs("h1",{className:r.title,children:["История клиента: ",t.name]})]}),e.jsx(a,{onClick:()=>p(!h),children:h?"Отменить":"Добавить процедуру"})]}),e.jsx(d,{className:r.clientInfo,children:e.jsxs("div",{className:r.infoGrid,children:[e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Телефон:"}),e.jsx("a",{href:`tel:${t.phone}`,children:t.phone})]}),t.email&&e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Email:"}),e.jsx("a",{href:`mailto:${t.email}`,children:t.email})]}),e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Всего визитов:"}),e.jsx("span",{children:t.totalVisits||0})]}),t.lastVisit&&e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Последний визит:"}),e.jsx("span",{children:new Date(t.lastVisit).toLocaleDateString("ru-RU")})]}),b>0&&e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Общая сумма:"}),e.jsx("span",{children:f(b)})]})]})}),h&&e.jsxs(d,{className:r.formCard,children:[e.jsx("h2",{children:"Добавить оказанную процедуру"}),e.jsxs("form",{onSubmit:V(P),className:r.form,children:[e.jsx(B,{name:"procedureId",control:L,rules:{required:"Выберите процедуру"},render:({field:s})=>e.jsx(U,{label:"Процедура",options:E,...s,error:n.procedureId?.message,showDefaultOption:!0})}),e.jsx(g,{label:"Дата оказания услуги",type:"date",...u("date",{required:"Укажите дату"}),error:n.date?.message}),e.jsx(g,{label:"Цена (опционально)",type:"number",step:"0.01",...u("price"),error:n.price?.message}),e.jsx(M,{label:"Заметки",...u("notes"),error:n.notes?.message,rows:3}),e.jsxs("div",{className:r.formActions,children:[e.jsx(a,{type:"submit",children:"Добавить"}),e.jsx(a,{type:"button",variant:"outline",onClick:()=>{S(),p(!1)},children:"Отменить"})]})]})]}),e.jsxs("div",{className:r.records,children:[e.jsx("h2",{children:"История процедур"}),m.length===0?e.jsx(d,{className:r.empty,children:e.jsx("p",{children:"Записей пока нет"})}):e.jsx("div",{className:r.recordsList,children:m.map(s=>e.jsxs(d,{className:r.recordCard,children:[e.jsxs("div",{className:r.recordHeader,children:[e.jsxs("div",{children:[e.jsx("h3",{children:s.procedureName}),e.jsx("p",{className:r.recordDate,children:new Date(s.date).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})})]}),s.price&&e.jsx("div",{className:r.recordPrice,children:f(s.price)})]}),s.notes&&e.jsxs("div",{className:r.recordNotes,children:[e.jsx("strong",{children:"Заметки:"})," ",s.notes]}),e.jsx("div",{className:r.recordActions,children:e.jsx(a,{size:"small",variant:"secondary",onClick:()=>T(s.id),children:"Удалить"})})]},s.id))})]})]}):e.jsxs("div",{className:r.error,children:[e.jsx("p",{children:"Клиент не найден"}),e.jsx(a,{onClick:()=>v(C.ADMIN_CLIENTS),children:"Вернуться к списку"})]})};export{fe as default};
