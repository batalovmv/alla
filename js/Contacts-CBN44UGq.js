import{u as he,a as se,C as ge,s as te,b as pe,r as fe,g as xe,e as Me,f as be,q as W,t as v,v as je,w as _e,j as e,h as ne,B as X,I as $,S as ye}from"./index-BdSluZxw.js";import{f as we,r as c}from"./react-vendor-BQWX9zlF.js";import{u as ke,a as O,C as re}from"./form-vendor-BjD3cHyu.js";import{f as Ne,i as ve,c as Se,b as Te}from"./useInView-CT0Cpwlt.js";import{n as De,v as Ie,M as Ce,a as qe}from"./MaskedPhoneInput-M9tyNpqN.js";import{T as He}from"./Textarea-B-13Wzae.js";import{S as Ee}from"./Select-BPFrSl0T.js";import{S as Pe}from"./SEO-B5-mY-jU.js";import{R as oe}from"./Reveal-CYTP6duW.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-CGxEfUHl.js";const I=["Пн","Вт","Ср","Чт","Пт","Сб","Вс"];function $e(t){const a=t.getDay();return a===0?"Вс":I[a-1]}function ae(t){const a=t.trim().match(/^(\d{1,2}):(\d{2})$/);if(!a)return null;const o=Number(a[1]),l=Number(a[2]);return!Number.isFinite(o)||!Number.isFinite(l)||o<0||o>23||l<0||l>59?null:o*60+l}function Be(t){const a=t.trim(),o=a.match(/^(Пн|Вт|Ср|Чт|Пт|Сб|Вс)\s*-\s*(Пн|Вт|Ср|Чт|Пт|Сб|Вс)$/);if(o){const p=o[1],u=o[2],m=I.indexOf(p),M=I.indexOf(u);return m===-1||M===-1?[]:m<=M?I.slice(m,M+1):[...I.slice(m),...I.slice(0,M+1)]}const l=a.match(/^(Пн|Вт|Ср|Чт|Пт|Сб|Вс)$/);return l?[l[1]]:[]}function B(t,a){const o=$e(a),l=String(t||"").split(",").map(p=>p.trim()).filter(Boolean);for(const p of l){const u=p.match(/^(.*?)\s*:\s*(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})\s*$/);if(!u)continue;const m=u[1];if(!Be(m).includes(o))continue;const n=ae(u[2]),h=ae(u[3]);if(!(n==null||h==null)&&!(h<=n))return{openMin:n,closeMin:h}}return null}function q(t,a){return Math.ceil(t/a)*a}function H(t){const a=Math.floor(t/60),o=t%60;return`${String(a).padStart(2,"0")}:${String(o).padStart(2,"0")}`}function S(t){const a=t.getFullYear(),o=String(t.getMonth()+1).padStart(2,"0"),l=String(t.getDate()).padStart(2,"0");return`${a}-${o}-${l}`}function ie(t){const a=t.now??new Date,o=t.leadMinutes??90,l=t.stepMinutes??15,p=new Date(a.getFullYear(),a.getMonth(),a.getDate()),u=B(t.workingHours,p),m=a.getHours()*60+a.getMinutes(),M=m+o;if(u){const n=u.closeMin-m<=60&&m<u.closeMin;if(m<u.openMin){const h=q(u.openMin+30,l);return{suggestedDate:S(p),suggestedTime:H(Math.min(h,u.closeMin-l)),notice:"Мы ещё не открылись — выбрано ближайшее доступное время.",isClosedNow:!0}}if(m>=u.openMin&&m<u.closeMin){const h=q(M,l);if(!(h>=u.closeMin))return{suggestedDate:S(p),suggestedTime:H(h),notice:n?"До закрытия остался примерно час — пожалуйста, выберите удобное время.":void 0,isClosingSoon:n}}}for(let n=1;n<=14;n++){const h=new Date(p);h.setDate(h.getDate()+n);const b=B(t.workingHours,h);if(!b)continue;const F=q(b.openMin+30,l);return{suggestedDate:S(h),suggestedTime:H(Math.min(F,b.closeMin-l)),notice:"Сейчас мы закрыты — выбрано ближайшее доступное время.",isClosedNow:!0}}return{suggestedDate:S(p),suggestedTime:"10:00",notice:"Не удалось распознать часы работы — выберите дату и время вручную.",isClosedNow:!0}}const Fe="_contacts_1nygq_1",Ae="_container_1nygq_6",Le="_title_1nygq_11",Re="_content_1nygq_19",We="_infoCard_1nygq_25",Xe="_formCard_1nygq_26",Oe="_contactItem_1nygq_37",Ve="_social_1nygq_63",ze="_socialLinks_1nygq_75",Ue="_map_1nygq_91",Ke="_mapPlaceholder_1nygq_97",Ye="_mapNote_1nygq_109",Ge="_form_1nygq_26",Je="_checkbox_1nygq_120",Qe="_successMessage_1nygq_138",Ze="_errorMessage_1nygq_147",es="_submitButton_1nygq_153",i={contacts:Fe,container:Ae,title:Le,content:Re,infoCard:We,formCard:Xe,contactItem:Oe,social:Ve,socialLinks:ze,map:Ue,mapPlaceholder:Ke,mapNote:Ye,form:Ge,checkbox:Je,successMessage:Qe,errorMessage:Ze,submitButton:es},ms=()=>{const t=he(),[a]=we(),{items:o,lastFetched:l,loading:p}=se(s=>s.procedures),{isSubmitting:u,success:m,error:M}=se(s=>s.booking),[n,h]=c.useState({...ge,mapEmbedUrl:"",whatsappPhone:""}),{register:b,handleSubmit:F,formState:{errors:_},reset:V,setValue:k,control:C}=ke({defaultValues:{consent:!1}}),A=O({control:C,name:"procedureId"}),x=O({control:C,name:"desiredDate"}),N=O({control:C,name:"desiredTime"}),z=c.useRef(null),U=c.useMemo(()=>`hp_${Math.random().toString(36).slice(2)}`,[]),K=c.useCallback(async()=>{t(te(!0));try{const s=await Ne();t(pe(s))}finally{t(te(!1))}},[t]);c.useEffect(()=>{(o.length===0||ve(l,3e5))&&K()},[o.length,l,K]),c.useEffect(()=>{const s=a.get("procedureId");if(s&&o.length>0&&o.some(d=>d.id===s)){const d=setTimeout(()=>{k("procedureId",s,{shouldValidate:!0,shouldDirty:!0})},0);return()=>clearTimeout(d)}},[a,o,k]),c.useEffect(()=>{if(m){V();const s=setTimeout(()=>{t(fe())},5e3);return()=>clearTimeout(s)}},[m,V,t]),c.useEffect(()=>{const s=!!x,r=!!N;if(s&&r)return;const{suggestedDate:d,suggestedTime:f}=ie({workingHours:n.workingHours,leadMinutes:90,stepMinutes:15});s||k("desiredDate",d,{shouldDirty:!1}),r||k("desiredTime",f,{shouldDirty:!1})},[n.workingHours]);const Y=c.useMemo(()=>ie({workingHours:n.workingHours,leadMinutes:90,stepMinutes:15}).notice||"",[n.workingHours]),y=c.useMemo(()=>{if(!x)return null;const s=new Date(`${x}T00:00:00`),r=B(n.workingHours,s);if(!r)return null;const d=new Date,f=S(d)===x,j=d.getHours()*60+d.getMinutes(),g=f?Math.max(r.openMin,j+30):r.openMin,w=Math.max(r.openMin,r.closeMin-60),D=H(q(g,15)),P=H(q(w,15));return{min:D,max:P}},[n.workingHours,x]);c.useEffect(()=>{if(!x||!y)return;if(!N){k("desiredTime",y.max,{shouldDirty:!1});return}const s=j=>{const[g,w]=j.split(":").map(Number);return!Number.isFinite(g)||!Number.isFinite(w)?null:g*60+w},r=s(N),d=s(y.min),f=s(y.max);r==null||d==null||f==null||(r<d&&k("desiredTime",y.min,{shouldValidate:!0,shouldDirty:!0}),r>f&&k("desiredTime",y.max,{shouldValidate:!0,shouldDirty:!0}))},[x,N,y,k]);const L=c.useMemo(()=>{if(!x||!N)return"";const s=new Date(`${x}T00:00:00`),r=B(n.workingHours,s);if(!r)return"Для выбранной даты часы работы не указаны. Пожалуйста, выберите другое время.";const[d,f]=N.split(":").map(Number);if(!Number.isFinite(d)||!Number.isFinite(f))return"Укажите корректное время.";const j=d*60+f;if(j<r.openMin||j>=r.closeMin)return"Мы не работаем в это время — выберите другое.";const g=new Date;if(S(g)===x){const D=g.getHours()*60+g.getMinutes();if(j<D+30)return"Пожалуйста, выберите время чуть позже (минимум через 30 минут)."}return""},[n.workingHours,x,N]);c.useEffect(()=>{let s=!0;return xe().then(r=>{s&&h(r)}).catch(()=>{}),()=>{s=!1}},[]);const ce=c.useMemo(()=>o.map(s=>({value:s.id,label:`${s.name} - ${s.price} ₽`})),[o]),R=c.useMemo(()=>A&&o.find(r=>r.id===A)?.name||"",[o,A]),E=c.useMemo(()=>{if(n.whatsappEnabled===!1)return null;const s="Здравствуйте! Хочу записаться в A.K.beauty.",r=R?`${s} Процедура: "${R}".`:s;return Me({whatsappPhone:n.whatsappPhone,text:r})},[n.whatsappEnabled,n.whatsappPhone,R]),T=c.useMemo(()=>be({telegramLink:n.socialMedia.telegram}),[n.socialMedia.telegram]),G=c.useMemo(()=>W(n.socialMedia.instagram),[n.socialMedia.instagram]),J=c.useMemo(()=>W(n.socialMedia.vk),[n.socialMedia.vk]),Q=c.useMemo(()=>W(n.socialMedia.whatsapp),[n.socialMedia.whatsapp]),le=c.useCallback(async s=>{const r=z.current?.value;if(r&&r.trim().length>0){t(v("Похоже, сработала защита от спама. Обновите страницу и попробуйте снова."));return}const d=Date.now(),f=localStorage.getItem("booking_last_submit_ts"),j=f?Number(f):0;if(j&&d-j<6e4){t(v("Пожалуйста, подождите минуту и попробуйте снова."));return}t(je());try{const g=De(s.phone);if(!g){t(v("Укажите телефон в формате +7 (XXX) XXX-XX-XX"));return}const w=String(s.procedureId??"").trim();if(!w){t(v("Выберите процедуру."));return}const D=o.find(me=>me.id===w);if(!D){t(v("Выбранная процедура не найдена. Обновите страницу и попробуйте снова."));return}const P=(s.email??"").trim(),de={...s,procedureId:w,phone:g,email:P||void 0},ee=await Se({...de,procedureName:D.name});ee.success?(localStorage.setItem("booking_last_submit_ts",String(d)),t(_e())):t(v(ee.message||"Ошибка отправки"))}catch(g){t(v(g instanceof Error?g.message:"Произошла ошибка"))}},[t,o]),Z=n.mapEmbedUrl||"",ue=Te(p&&o.length===0,160);return e.jsxs(e.Fragment,{children:[e.jsx(Pe,{title:"Контакты и запись",description:"Свяжитесь с нами или запишитесь на консультацию. Телефон, адрес, форма записи на сеанс.",keywords:"контакты косметолог, запись на процедуру, косметология контакты"}),e.jsx("div",{className:i.contacts,children:e.jsxs("div",{className:i.container,children:[e.jsx("h1",{className:i.title,children:"Контакты и запись"}),e.jsxs("div",{className:i.content,children:[e.jsx("div",{className:i.infoSection,children:e.jsx(oe,{children:e.jsxs(ne,{className:i.infoCard,children:[e.jsx("h2",{children:"Контактная информация"}),e.jsxs("div",{className:i.contactItem,children:[e.jsx("strong",{children:"Телефон:"}),e.jsx("a",{href:`tel:${n.phone}`,children:n.phone})]}),E&&e.jsxs("div",{className:i.contactItem,children:[e.jsx("strong",{children:"WhatsApp:"}),e.jsx("a",{href:E,target:"_blank",rel:"noopener noreferrer",children:"Написать в WhatsApp"})]}),T&&e.jsxs("div",{className:i.contactItem,children:[e.jsx("strong",{children:"Telegram:"}),e.jsx("a",{href:T,target:"_blank",rel:"noopener noreferrer",children:"Написать в Telegram"})]}),e.jsxs("div",{className:i.contactItem,children:[e.jsx("strong",{children:"Email:"}),e.jsx("a",{href:`mailto:${n.email}`,children:n.email})]}),e.jsxs("div",{className:i.contactItem,children:[e.jsx("strong",{children:"Адрес:"}),e.jsx("p",{children:n.address})]}),e.jsxs("div",{className:i.contactItem,children:[e.jsx("strong",{children:"Часы работы:"}),e.jsx("p",{children:n.workingHours})]}),e.jsxs("div",{className:i.social,children:[e.jsx("h3",{children:"Социальные сети"}),e.jsxs("div",{className:i.socialLinks,children:[G&&e.jsx("a",{href:G,target:"_blank",rel:"noopener noreferrer",children:"Instagram"}),J&&e.jsx("a",{href:J,target:"_blank",rel:"noopener noreferrer",children:"VK"}),T&&e.jsx("a",{href:T,target:"_blank",rel:"noopener noreferrer",children:"Telegram"}),Q&&e.jsx("a",{href:Q,target:"_blank",rel:"noopener noreferrer",children:"WhatsApp"})]})]}),e.jsx("div",{className:i.map,children:Z?e.jsx("iframe",{title:"Карта",src:Z,loading:"lazy",referrerPolicy:"no-referrer-when-downgrade",style:{width:"100%",height:320,border:0,borderRadius:12}}):e.jsxs("div",{className:i.mapPlaceholder,children:[e.jsx("p",{children:"Карта местоположения"}),e.jsx("p",{className:i.mapNote,children:"Укажите VITE_MAP_EMBED_URL в .env.local (или заполните ссылку в админке → Контакты), чтобы встроить карту"})]})})]})})}),e.jsx("div",{className:i.formSection,children:e.jsx(oe,{delayMs:60,children:e.jsxs(ne,{className:i.formCard,children:[e.jsx("h2",{children:"Записаться на сеанс"}),m&&e.jsxs("div",{className:i.successMessage,children:["✓ Ваша заявка успешно отправлена! Мы свяжемся с вами в ближайшее время.",E&&e.jsx("div",{style:{marginTop:12},children:e.jsx("a",{href:E,target:"_blank",rel:"noopener noreferrer",children:e.jsx(X,{variant:"outline",size:"small",children:"Написать в WhatsApp сейчас"})})}),T&&e.jsx("div",{style:{marginTop:12},children:e.jsx("a",{href:T,target:"_blank",rel:"noopener noreferrer",children:e.jsx(X,{variant:"outline",size:"small",children:"Написать в Telegram сейчас"})})})]}),M&&e.jsxs("div",{className:i.errorMessage,children:["✗ ",M]}),e.jsxs("form",{onSubmit:F(le),className:i.form,children:[e.jsx("input",{ref:z,id:U,name:U,type:"text",tabIndex:-1,autoComplete:"off",style:{position:"absolute",left:"-10000px",top:"auto"},"aria-hidden":"true"}),e.jsx($,{label:"Имя",...b("name",{required:"Имя обязательно для заполнения",minLength:{value:2,message:"Имя должно содержать минимум 2 символа"}}),error:_.name?.message}),e.jsx(re,{name:"phone",control:C,rules:{required:"Телефон обязателен для заполнения",validate:s=>Ie(String(s||""))||"Неверный формат телефона"},render:({field:s})=>e.jsx(Ce,{label:"Телефон",inputMode:"tel",autoComplete:"tel",value:String(s.value||""),onChange:r=>s.onChange(r),onBlur:s.onBlur,required:!0,error:_.phone?.message})}),e.jsx($,{label:"Email (необязательно)",type:"email",inputMode:"email",autoComplete:"email",placeholder:"name@example.com",...b("email",{validate:s=>!s||qe(s)||"Неверный формат email"}),error:_.email?.message}),e.jsx(re,{name:"procedureId",control:C,rules:{required:"Выберите процедуру"},render:({field:s})=>ue?e.jsxs("div",{style:{display:"grid",gap:6},children:[e.jsx("label",{style:{fontWeight:600,fontSize:14},children:"Процедура"}),e.jsx(ye,{height:56,radius:12})]}):e.jsx(Ee,{label:"Процедура",options:ce,...s,error:_.procedureId?.message})}),e.jsx($,{label:"Желаемая дата",type:"date",...b("desiredDate",{required:"Укажите желаемую дату",validate:s=>{if(!s)return"Укажите желаемую дату";const r=S(new Date);return s<r?"Нельзя выбрать прошедшую дату":!0}}),error:_.desiredDate?.message}),e.jsx($,{label:"Желаемое время",type:"time",step:900,min:y?.min,max:y?.max,...b("desiredTime",{required:"Укажите желаемое время",validate:()=>L||!0}),error:_.desiredTime?.message||L||Y||void 0}),e.jsx(He,{label:"Комментарий",...b("comment",{maxLength:{value:2e3,message:"Комментарий не должен превышать 2000 символов"}}),error:_.comment?.message}),e.jsxs("div",{className:i.checkbox,children:[e.jsx("input",{type:"checkbox",id:"consent",...b("consent",{required:"Необходимо согласие на обработку персональных данных"})}),e.jsxs("label",{htmlFor:"consent",children:["Я согласен(а) на обработку персональных данных."," ",e.jsx("a",{href:"/alla/privacy",target:"_blank",rel:"noopener noreferrer",children:"Политика конфиденциальности"})]}),_.consent&&e.jsx("span",{className:i.errorMessage,children:_.consent.message})]}),e.jsx(X,{type:"submit",size:"large",disabled:u,className:i.submitButton,children:u?"Отправка...":"Отправить заявку"})]})]})})})]})]})})]})};export{ms as default};
