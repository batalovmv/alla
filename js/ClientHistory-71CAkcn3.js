import{O as _,K as j,x as k,j as e,p as F,B as a,R as b,h as d,I as g}from"./index-DRfPQ-Id.js";import{e as H,b as O,r as i}from"./react-vendor-BQWX9zlF.js";import{u as U,C as G}from"./form-vendor-BjD3cHyu.js";import{T as $}from"./Textarea-Do8-fHgy.js";import{S as B}from"./Select-BVZ1aTj_.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-CGxEfUHl.js";const M="_history_1scv0_1",q="_header_1scv0_5",z="_title_1scv0_20",K="_error_1scv0_27",J="_clientInfo_1scv0_37",Q="_infoGrid_1scv0_42",W="_label_1scv0_54",X="_formCard_1scv0_69",Y="_form_1scv0_69",Z="_formActions_1scv0_85",ee="_records_1scv0_91",se="_empty_1scv0_95",re="_recordsList_1scv0_102",te="_recordCard_1scv0_107",ce="_recordHeader_1scv0_111",ae="_recordDate_1scv0_123",ie="_recordPrice_1scv0_129",oe="_recordNotes_1scv0_135",ne="_recordActions_1scv0_143",r={history:M,header:q,title:z,error:K,clientInfo:J,infoGrid:Q,label:W,formCard:X,form:Y,formActions:Z,records:ee,empty:se,recordsList:re,recordCard:te,recordHeader:ce,recordDate:ae,recordPrice:ie,recordNotes:oe,recordActions:ne},_e=()=>{const{clientId:o}=H(),v=O(),[t,C]=i.useState(null),[m,D]=i.useState([]),[f,I]=i.useState([]),[w,N]=i.useState(!0),[h,p]=i.useState(!1),{register:u,handleSubmit:A,control:L,formState:{errors:n},reset:y}=U({defaultValues:{date:new Date().toISOString().split("T")[0]}});i.useEffect(()=>{o&&x()},[o]);const x=async()=>{try{if(N(!0),o){const[s,c,l]=await Promise.all([_.get(o),j.getByClientId(o),k.getAll()]);C(s),D(c),I(l)}}catch(s){console.error("Ошибка загрузки данных:",s)}finally{N(!1)}},V=async s=>{if(t)try{const c=f.find(E=>E.id===s.procedureId);if(!c){alert("Процедура не найдена");return}const l=new Date(s.date);await j.create({clientId:t.id,clientPhone:t.phone,clientName:t.name,procedureId:c.id,procedureName:c.name,date:l,price:s.price?parseFloat(s.price):c.price,notes:s.notes||void 0});const T=(t.totalVisits||0)+1;await _.update(t.id,{totalVisits:T,lastVisit:l}),y(),p(!1),await x()}catch(c){console.error("Ошибка создания записи:",c),alert("Ошибка при создании записи")}},P=async s=>{if(confirm("Удалить эту запись?"))try{if(await j.delete(s),t){const c=Math.max((t.totalVisits||0)-1,0);await _.update(t.id,{totalVisits:c})}await x()}catch(c){console.error("Ошибка удаления записи:",c),alert("Ошибка при удалении записи")}},R=f.map(s=>({value:s.id,label:`${s.name} - ${s.price} ₽`})),S=m.reduce((s,c)=>s+(c.price||0),0);return w?e.jsx(F,{variant:"admin"}):t?e.jsxs("div",{className:r.history,children:[e.jsxs("div",{className:r.header,children:[e.jsxs("div",{children:[e.jsx(a,{variant:"outline",onClick:()=>v(b.ADMIN_CLIENTS),children:"← Назад к списку"}),e.jsxs("h1",{className:r.title,children:["История клиента: ",t.name]})]}),e.jsx(a,{onClick:()=>p(!h),children:h?"Отменить":"Добавить процедуру"})]}),e.jsx(d,{className:r.clientInfo,children:e.jsxs("div",{className:r.infoGrid,children:[e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Телефон:"}),e.jsx("a",{href:`tel:${t.phone}`,children:t.phone})]}),t.email&&e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Email:"}),e.jsx("a",{href:`mailto:${t.email}`,children:t.email})]}),e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Всего визитов:"}),e.jsx("span",{children:t.totalVisits||0})]}),t.lastVisit&&e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Последний визит:"}),e.jsx("span",{children:new Date(t.lastVisit).toLocaleDateString("ru-RU")})]}),S>0&&e.jsxs("div",{children:[e.jsx("span",{className:r.label,children:"Общая сумма:"}),e.jsxs("span",{children:[S.toLocaleString("ru-RU")," ₽"]})]})]})}),h&&e.jsxs(d,{className:r.formCard,children:[e.jsx("h2",{children:"Добавить оказанную процедуру"}),e.jsxs("form",{onSubmit:A(V),className:r.form,children:[e.jsx(G,{name:"procedureId",control:L,rules:{required:"Выберите процедуру"},render:({field:s})=>e.jsx(B,{label:"Процедура",options:R,...s,error:n.procedureId?.message,showDefaultOption:!0})}),e.jsx(g,{label:"Дата оказания услуги",type:"date",...u("date",{required:"Укажите дату"}),error:n.date?.message}),e.jsx(g,{label:"Цена (опционально)",type:"number",step:"0.01",...u("price"),error:n.price?.message}),e.jsx($,{label:"Заметки",...u("notes"),error:n.notes?.message,rows:3}),e.jsxs("div",{className:r.formActions,children:[e.jsx(a,{type:"submit",children:"Добавить"}),e.jsx(a,{type:"button",variant:"outline",onClick:()=>{y(),p(!1)},children:"Отменить"})]})]})]}),e.jsxs("div",{className:r.records,children:[e.jsx("h2",{children:"История процедур"}),m.length===0?e.jsx(d,{className:r.empty,children:e.jsx("p",{children:"Записей пока нет"})}):e.jsx("div",{className:r.recordsList,children:m.map(s=>e.jsxs(d,{className:r.recordCard,children:[e.jsxs("div",{className:r.recordHeader,children:[e.jsxs("div",{children:[e.jsx("h3",{children:s.procedureName}),e.jsx("p",{className:r.recordDate,children:new Date(s.date).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric"})})]}),s.price&&e.jsxs("div",{className:r.recordPrice,children:[s.price.toLocaleString("ru-RU")," ₽"]})]}),s.notes&&e.jsxs("div",{className:r.recordNotes,children:[e.jsx("strong",{children:"Заметки:"})," ",s.notes]}),e.jsx("div",{className:r.recordActions,children:e.jsx(a,{size:"small",variant:"secondary",onClick:()=>P(s.id),children:"Удалить"})})]},s.id))})]})]}):e.jsxs("div",{className:r.error,children:[e.jsx("p",{children:"Клиент не найден"}),e.jsx(a,{onClick:()=>v(b.ADMIN_CLIENTS),children:"Вернуться к списку"})]})};export{_e as default};
