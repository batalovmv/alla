const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index-Cq7koZby.js","js/react-vendor-BQWX9zlF.js","js/redux-vendor-B8TTZsxA.js","js/firebase-vendor-CGxEfUHl.js","js/form-vendor-BjD3cHyu.js","assets/index-lJ93MZ9V.css"])))=>i.map(i=>d[i]);
import{A as x,x as w,j as a,p as A,h as j,B as d,_ as B}from"./index-Cq7koZby.js";import{r as m}from"./react-vendor-BQWX9zlF.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-CGxEfUHl.js";import"./form-vendor-BjD3cHyu.js";const b="_bookings_1a2f0_1",D="_title_1a2f0_5",z="_tabs_1a2f0_10",E="_tab_1a2f0_10",F="_tabActive_1a2f0_39",V="_empty_1a2f0_69",$="_list_1a2f0_75",L="_bookingCard_1a2f0_81",P="_bookingHeader_1a2f0_85",H="_clientName_1a2f0_94",T="_procedureName_1a2f0_100",U="_status_1a2f0_106",O="_awaiting_1a2f0_119",q="_completed_1a2f0_124",G="_cancelled_1a2f0_129",J="_bookingInfo_1a2f0_134",K="_infoRow_1a2f0_138",M="_label_1a2f0_144",Q="_phone_1a2f0_150",W="_comment_1a2f0_159",X="_actions_1a2f0_171",s={bookings:b,title:D,tabs:z,tab:E,tabActive:F,empty:V,list:$,bookingCard:L,bookingHeader:P,clientName:H,procedureName:T,status:U,new:"_new_1a2f0_113",awaiting:O,completed:q,cancelled:G,bookingInfo:J,infoRow:K,label:M,phone:Q,comment:W,actions:X},se=()=>{const[u,v]=m.useState([]),[N,h]=m.useState(!0),[p,S]=m.useState("new");m.useEffect(()=>{f()},[p]);const f=async()=>{try{h(!0);let t=await x.getAll();const n=await w.getAll();t=t.map(c=>{if(!c.procedureName&&c.procedureId){const o=n.find(l=>l.id===c.procedureId);if(o)return{...c,procedureName:o.name}}return c}),t=t.filter(c=>(c.status==="processed"?"awaiting":c.status)===p),v(t)}catch(e){console.error("Ошибка загрузки заявок:",e)}finally{h(!1)}},r=async(e,t)=>{try{if(await x.update(e,{status:t}),t==="completed"){const n=u.find(c=>c.id===e);n&&await y(n)}await f()}catch(n){console.error("Ошибка обновления статуса:",n),alert("Ошибка при обновлении статуса")}},y=async e=>{try{const{clientsService:t,serviceRecordsService:n}=await B(async()=>{const{clientsService:i,serviceRecordsService:_}=await import("./index-Cq7koZby.js").then(I=>I.T);return{clientsService:i,serviceRecordsService:_}},__vite__mapDeps([0,1,2,3,4,5])),o=(await w.getAll()).find(i=>i.id===e.procedureId);let l=await t.getByPhone(e.phone);if(!l){const i=await t.create({phone:e.phone,name:e.name,email:e.email,totalVisits:0});l=await t.get(i)}if(l){const i=new Date(e.desiredDate);await n.create({clientId:l.id,clientPhone:e.phone,clientName:e.name,procedureId:e.procedureId,procedureName:e.procedureName,date:i,price:o?.price??0,notes:e.comment||void 0,bookingId:e.id});const _=(l.totalVisits||0)+1;await t.update(l.id,{totalVisits:_,lastVisit:i})}}catch(t){console.error("Ошибка создания записи об услуге:",t)}},C=[{value:"new",label:"Новые"},{value:"awaiting",label:"Ожидание"},{value:"completed",label:"Выполненные"},{value:"cancelled",label:"Отмененные"}],R=e=>{switch(e){case"new":return"Новая";case"awaiting":return"Ожидание";case"completed":return"Выполнена";case"cancelled":return"Отменена";default:return e}},g=e=>{switch(e){case"new":return s.new;case"awaiting":return s.awaiting;case"completed":return s.completed;case"cancelled":return s.cancelled;default:return""}};return N?a.jsx(A,{variant:"admin"}):a.jsxs("div",{className:s.bookings,children:[a.jsx("h1",{className:s.title,children:"Заявки на запись"}),a.jsx("div",{className:s.tabs,children:C.map(e=>a.jsx("button",{className:`${s.tab} ${p===e.value?s.tabActive:""}`,onClick:()=>S(e.value),children:e.label},e.value))}),u.length===0?a.jsx(j,{className:s.empty,children:a.jsx("p",{children:"Заявок нет"})}):a.jsx("div",{className:s.list,children:u.map(e=>a.jsxs(j,{className:s.bookingCard,children:[a.jsxs("div",{className:s.bookingHeader,children:[a.jsxs("div",{children:[a.jsx("h3",{className:s.clientName,children:e.name}),a.jsx("p",{className:s.procedureName,children:e.procedureName})]}),a.jsx("span",{className:`${s.status} ${g(e.status)}`,children:R(e.status)})]}),a.jsxs("div",{className:s.bookingInfo,children:[a.jsxs("div",{className:s.infoRow,children:[a.jsx("span",{className:s.label,children:"Телефон:"}),a.jsx("a",{href:`tel:${e.phone}`,className:s.phone,children:e.phone})]}),e.email&&a.jsxs("div",{className:s.infoRow,children:[a.jsx("span",{className:s.label,children:"Email:"}),a.jsx("a",{href:`mailto:${e.email}`,children:e.email})]}),a.jsxs("div",{className:s.infoRow,children:[a.jsx("span",{className:s.label,children:"Желаемая дата:"}),a.jsx("span",{children:new Date(e.desiredDate).toLocaleDateString("ru-RU")})]}),a.jsxs("div",{className:s.infoRow,children:[a.jsx("span",{className:s.label,children:"Желаемое время:"}),a.jsx("span",{children:e.desiredTime})]}),e.comment&&a.jsxs("div",{className:s.comment,children:[a.jsx("span",{className:s.label,children:"Комментарий:"}),a.jsx("p",{children:e.comment})]}),a.jsxs("div",{className:s.infoRow,children:[a.jsx("span",{className:s.label,children:"Дата заявки:"}),a.jsx("span",{children:new Date(e.createdAt).toLocaleString("ru-RU")})]})]}),a.jsxs("div",{className:s.actions,children:[e.status==="new"&&a.jsxs(a.Fragment,{children:[a.jsx(d,{size:"small",onClick:()=>r(e.id,"awaiting"),children:"В ожидание"}),a.jsx(d,{size:"small",variant:"secondary",onClick:()=>r(e.id,"cancelled"),children:"Отменить"})]}),e.status==="awaiting"&&a.jsxs(a.Fragment,{children:[a.jsx(d,{size:"small",onClick:()=>r(e.id,"completed"),children:"Выполнена"}),a.jsx(d,{size:"small",variant:"secondary",onClick:()=>r(e.id,"cancelled"),children:"Отменить"}),a.jsx(d,{size:"small",variant:"outline",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"})]}),e.status==="completed"&&a.jsx(d,{size:"small",variant:"outline",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"}),e.status==="cancelled"&&a.jsx(d,{size:"small",onClick:()=>r(e.id,"new"),children:"Вернуть в новые"})]})]},e.id))})]})};export{se as default};
