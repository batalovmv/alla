const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["js/index-TBdT1FO9.js","js/react-vendor-BQWX9zlF.js","js/redux-vendor-B8TTZsxA.js","js/firebase-vendor-mpaoXh-M.js","js/form-vendor-BjD3cHyu.js","assets/index-lJ93MZ9V.css"])))=>i.map(i=>d[i]);
import{J as g,F as f,j as e,p as A,h as C,B as n,a0 as $,_ as B}from"./index-TBdT1FO9.js";import{r as u}from"./react-vendor-BQWX9zlF.js";import"./redux-vendor-B8TTZsxA.js";import"./firebase-vendor-mpaoXh-M.js";import"./form-vendor-BjD3cHyu.js";const E="_bookings_1gwuj_1",F="_title_1gwuj_5",M="_tabs_1gwuj_10",T="_tab_1gwuj_10",k="_tabActive_1gwuj_39",P="_empty_1gwuj_69",G="_list_1gwuj_75",H="_bookingCard_1gwuj_81",U="_bookingHeader_1gwuj_85",O="_headerMain_1gwuj_94",q="_clientName_1gwuj_98",J="_procedureName_1gwuj_104",K="_metaLine_1gwuj_110",Q="_status_1gwuj_116",W="_awaiting_1gwuj_129",X="_completed_1gwuj_134",Y="_cancelled_1gwuj_139",Z="_bookingInfo_1gwuj_144",ee="_infoRow_1gwuj_148",ae="_label_1gwuj_154",se="_phone_1gwuj_160",le="_comment_1gwuj_169",te="_actions_1gwuj_181",ne="_modalContent_1gwuj_189",ce="_modalGrid_1gwuj_194",ie="_modalRow_1gwuj_199",de="_modalLabel_1gwuj_206",re="_modalValue_1gwuj_211",oe="_modalActions_1gwuj_216",s={bookings:E,title:F,tabs:M,tab:T,tabActive:k,empty:P,list:G,bookingCard:H,bookingHeader:U,headerMain:O,clientName:q,procedureName:J,metaLine:K,status:Q,new:"_new_1gwuj_123",awaiting:W,completed:X,cancelled:Y,bookingInfo:Z,infoRow:ee,label:ae,phone:se,comment:le,actions:te,modalContent:ne,modalGrid:ce,modalRow:ie,modalLabel:de,modalValue:re,modalActions:oe},we=()=>{const[j,R]=u.useState([]),[L,p]=u.useState(!0),[_,S]=u.useState("new"),[l,r]=u.useState(null),[x,y]=u.useState(!1);u.useEffect(()=>{const a=window.matchMedia("(max-width: 768px)"),t=()=>y(a.matches);return t(),a.addEventListener?.("change",t),()=>a.removeEventListener?.("change",t)},[]),u.useEffect(()=>{v()},[_]);const v=async()=>{try{p(!0);let t=await g.getAll();const i=await f.getAll();t=t.map(d=>{if(!d.procedureName&&d.procedureId){const h=i.find(o=>o.id===d.procedureId);if(h)return{...d,procedureName:h.name}}return d}),t=t.filter(d=>(d.status==="processed"?"awaiting":d.status)===_),R(t)}catch(a){console.error("Ошибка загрузки заявок:",a)}finally{p(!1)}},c=async(a,t)=>{try{if(await g.update(a,{status:t}),t==="completed"){const i=j.find(d=>d.id===a);i&&await b(i)}await v()}catch(i){console.error("Ошибка обновления статуса:",i),alert("Ошибка при обновлении статуса")}},b=async a=>{try{const{clientsService:t,serviceRecordsService:i}=await B(async()=>{const{clientsService:m,serviceRecordsService:w}=await import("./index-TBdT1FO9.js").then(I=>I.a2);return{clientsService:m,serviceRecordsService:w}},__vite__mapDeps([0,1,2,3,4,5])),h=(await f.getAll()).find(m=>m.id===a.procedureId);let o=await t.getByPhone(a.phone);if(!o){const m=await t.create({phone:a.phone,name:a.name,email:a.email,totalVisits:0});o=await t.get(m)}if(o){const m=new Date(a.desiredDate);await i.create({clientId:o.id,clientPhone:a.phone,clientName:a.name,procedureId:a.procedureId,procedureName:a.procedureName,date:m,price:h?.price??0,notes:a.comment||void 0,bookingId:a.id});const w=(o.totalVisits||0)+1;await t.update(o.id,{totalVisits:w,lastVisit:m})}}catch(t){console.error("Ошибка создания записи об услуге:",t)}},z=[{value:"new",label:"Новые (не обработаны)"},{value:"awaiting",label:"Записаны (подтверждены)"},{value:"completed",label:"Услуга оказана"},{value:"cancelled",label:"Отменено"}],N=a=>{switch(a){case"new":return"Новая";case"awaiting":return"Записана";case"completed":return"Услуга оказана";case"cancelled":return"Отменена";default:return a}},D=a=>{switch(a){case"new":return s.new;case"awaiting":return s.awaiting;case"completed":return s.completed;case"cancelled":return s.cancelled;default:return""}};if(L)return e.jsx(A,{variant:"admin"});const V=u.useMemo(()=>{if(!l)return"";const a=l.desiredDate?new Date(l.desiredDate).toLocaleDateString("ru-RU"):"",t=l.desiredTime||"",i=[a,t].filter(Boolean).join(" • ");return i?`Заявка • ${l.name} • ${i}`:`Заявка • ${l.name}`},[l]);return e.jsxs("div",{className:s.bookings,children:[e.jsx("h1",{className:s.title,children:"Заявки на запись"}),e.jsx("div",{className:s.tabs,children:z.map(a=>e.jsx("button",{className:`${s.tab} ${_===a.value?s.tabActive:""}`,onClick:()=>S(a.value),children:a.label},a.value))}),j.length===0?e.jsx(C,{className:s.empty,children:e.jsx("p",{children:"Заявок нет"})}):e.jsx("div",{className:s.list,children:j.map(a=>e.jsxs(C,{className:s.bookingCard,onClick:x?()=>r(a):void 0,children:[e.jsxs("div",{className:s.bookingHeader,children:[e.jsxs("div",{className:s.headerMain,children:[e.jsx("h3",{className:s.clientName,children:a.name}),e.jsx("p",{className:s.procedureName,children:a.procedureName}),e.jsxs("p",{className:s.metaLine,children:[new Date(a.desiredDate).toLocaleDateString("ru-RU")," • ",a.desiredTime||"—"]})]}),e.jsx("span",{className:`${s.status} ${D(a.status)}`,children:N(a.status)})]}),!x&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:s.bookingInfo,children:[e.jsxs("div",{className:s.infoRow,children:[e.jsx("span",{className:s.label,children:"Телефон:"}),e.jsx("a",{href:`tel:${a.phone}`,className:s.phone,children:a.phone})]}),a.email&&e.jsxs("div",{className:s.infoRow,children:[e.jsx("span",{className:s.label,children:"Email:"}),e.jsx("a",{href:`mailto:${a.email}`,children:a.email})]}),a.comment&&e.jsxs("div",{className:s.comment,children:[e.jsx("span",{className:s.label,children:"Комментарий:"}),e.jsx("p",{children:a.comment})]}),e.jsxs("div",{className:s.infoRow,children:[e.jsx("span",{className:s.label,children:"Дата заявки:"}),e.jsx("span",{children:new Date(a.createdAt).toLocaleString("ru-RU")})]})]}),e.jsxs("div",{className:s.actions,children:[a.status==="new"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{size:"small",onClick:()=>c(a.id,"awaiting"),children:"Записать / подтвердить"}),e.jsx(n,{size:"small",variant:"secondary",onClick:()=>c(a.id,"cancelled"),children:"Отменить"})]}),a.status==="awaiting"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{size:"small",onClick:()=>c(a.id,"completed"),children:"Услуга оказана"}),e.jsx(n,{size:"small",variant:"secondary",onClick:()=>c(a.id,"cancelled"),children:"Отменить"}),e.jsx(n,{size:"small",variant:"outline",onClick:()=>c(a.id,"new"),children:"Вернуть в новые"})]}),a.status==="completed"&&e.jsx(n,{size:"small",variant:"outline",onClick:()=>c(a.id,"new"),children:"Вернуть в новые"}),a.status==="cancelled"&&e.jsx(n,{size:"small",onClick:()=>c(a.id,"new"),children:"Вернуть в новые"})]})]})]},a.id))}),e.jsx($,{isOpen:!!l,onClose:()=>r(null),title:V,children:l&&e.jsxs("div",{className:s.modalContent,children:[e.jsxs("div",{className:s.modalGrid,children:[e.jsxs("div",{className:s.modalRow,children:[e.jsx("div",{className:s.modalLabel,children:"Процедура"}),e.jsx("div",{className:s.modalValue,children:l.procedureName||"—"})]}),e.jsxs("div",{className:s.modalRow,children:[e.jsx("div",{className:s.modalLabel,children:"Дата/время"}),e.jsxs("div",{className:s.modalValue,children:[new Date(l.desiredDate).toLocaleDateString("ru-RU")," • ",l.desiredTime||"—"]})]}),e.jsxs("div",{className:s.modalRow,children:[e.jsx("div",{className:s.modalLabel,children:"Телефон"}),e.jsx("div",{className:s.modalValue,children:e.jsx("a",{href:`tel:${l.phone}`,children:l.phone})})]}),l.email&&e.jsxs("div",{className:s.modalRow,children:[e.jsx("div",{className:s.modalLabel,children:"Email"}),e.jsx("div",{className:s.modalValue,children:e.jsx("a",{href:`mailto:${l.email}`,children:l.email})})]}),l.comment&&e.jsxs("div",{className:s.modalRow,children:[e.jsx("div",{className:s.modalLabel,children:"Комментарий"}),e.jsx("div",{className:s.modalValue,children:l.comment})]}),e.jsxs("div",{className:s.modalRow,children:[e.jsx("div",{className:s.modalLabel,children:"Статус"}),e.jsx("div",{className:s.modalValue,children:N(l.status)})]})]}),e.jsxs("div",{className:s.modalActions,children:[l.status==="new"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{size:"small",onClick:()=>c(l.id,"awaiting").then(()=>r(null)),children:"Записать / подтвердить"}),e.jsx(n,{size:"small",variant:"secondary",onClick:()=>c(l.id,"cancelled").then(()=>r(null)),children:"Отменить"})]}),l.status==="awaiting"&&e.jsxs(e.Fragment,{children:[e.jsx(n,{size:"small",onClick:()=>c(l.id,"completed").then(()=>r(null)),children:"Услуга оказана"}),e.jsx(n,{size:"small",variant:"secondary",onClick:()=>c(l.id,"cancelled").then(()=>r(null)),children:"Отменить"}),e.jsx(n,{size:"small",variant:"outline",onClick:()=>c(l.id,"new").then(()=>r(null)),children:"Вернуть в новые"})]}),l.status==="completed"&&e.jsx(n,{size:"small",variant:"outline",onClick:()=>c(l.id,"new").then(()=>r(null)),children:"Вернуть в новые"}),l.status==="cancelled"&&e.jsx(n,{size:"small",onClick:()=>c(l.id,"new").then(()=>r(null)),children:"Вернуть в новые"}),e.jsx(n,{size:"small",variant:"secondary",onClick:()=>r(null),children:"Закрыть"})]})]})})]})};export{we as default};
