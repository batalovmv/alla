rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Admin access should be based on Firebase Custom Claims:
    // set `admin: true` on the user via Firebase Admin SDK / Cloud Function / CLI tooling.
    function isAdmin() {
      return request.auth != null && request.auth.token.admin == true;
    }

    // Basic helpers
    function isNonEmptyString(v, maxLen) {
      return v is string && v.size() > 0 && v.size() <= maxLen;
    }

    // Процедуры: публичное чтение, запись только админ
    match /procedures/{procedureId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Отзывы:
    // - публично читаем только одобренные
    // - создавать могут все, но БЕЗ возможности выставить approved (это делает только админ)
    // - модерация/удаление только админ
    match /reviews/{reviewId} {
      allow read: if resource.data.approved == true || isAdmin();
      allow create: if
        request.resource.data.keys().hasOnly([
          "clientName",
          "procedureId",
          "procedureName",
          "rating",
          "text",
          "date",
          "createdAt"
        ])
        && !request.resource.data.keys().hasAny(["approved"])
        && isNonEmptyString(request.resource.data.clientName, 80)
        && isNonEmptyString(request.resource.data.procedureId, 128)
        && isNonEmptyString(request.resource.data.procedureName, 200)
        && request.resource.data.rating is int
        && request.resource.data.rating >= 1
        && request.resource.data.rating <= 5
        && isNonEmptyString(request.resource.data.text, 2000)
        && isNonEmptyString(request.resource.data.date, 32)
        && request.resource.data.createdAt is timestamp
        // мягкая защита от подделки времени
        && request.resource.data.createdAt <= request.time
        && request.resource.data.createdAt >= request.time - duration.value(10, "m");

      allow update, delete: if isAdmin();
    }

    // Метаданные отзыва (PII), например телефон для сверки админом:
    // - писать может любой (при отправке отзыва), но читать/менять может только админ
    match /reviewMeta/{reviewId} {
      allow create: if
        // Reduce PII abuse: require matching review document to exist.
        exists(/databases/$(database)/documents/reviews/$(reviewId))
        &&
        request.resource.data.keys().hasOnly([
          "phone",
          "createdAt"
        ])
        && isNonEmptyString(request.resource.data.phone, 32)
        && request.resource.data.createdAt is timestamp
        && request.resource.data.createdAt <= request.time
        && request.resource.data.createdAt >= request.time - duration.value(10, "m");
      allow read, update, delete: if isAdmin();
    }

    // Заявки:
    // - публичное создание, но строго по схеме
    // - читать/обновлять/удалять только админ
    match /bookings/{bookingId} {
      allow create: if
        request.resource.data.keys().hasOnly([
          "name",
          "phone",
          "email",
          "procedureId",
          "procedureName",
          "desiredDate",
          "desiredTime",
          "comment",
          "consent",
          "status",
          "createdAt"
        ])
        && isNonEmptyString(request.resource.data.name, 80)
        && isNonEmptyString(request.resource.data.phone, 32)
        && (request.resource.data.email == null || isNonEmptyString(request.resource.data.email, 120))
        && isNonEmptyString(request.resource.data.procedureId, 128)
        && (request.resource.data.procedureName == null || isNonEmptyString(request.resource.data.procedureName, 200))
        && isNonEmptyString(request.resource.data.desiredDate, 32)
        && isNonEmptyString(request.resource.data.desiredTime, 32)
        && (request.resource.data.comment == null || (request.resource.data.comment is string && request.resource.data.comment.size() <= 2000))
        && request.resource.data.consent is bool
        && request.resource.data.consent == true
        && request.resource.data.status == "new"
        && request.resource.data.createdAt is timestamp
        && request.resource.data.createdAt <= request.time
        && request.resource.data.createdAt >= request.time - duration.value(10, "m");

      allow read, update, delete: if isAdmin();
    }

    // Клиенты: только админ (PII)
    match /clients/{clientId} {
      allow read, write: if isAdmin();
    }

    // История услуг: только админ (PII)
    match /serviceRecords/{recordId} {
      allow read, write: if isAdmin();
    }

    // Контакты/о специалисте: читать могут все, писать только админ
    match /contactInfo/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /aboutInfo/{document} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}


