# Настройка индексов Firestore

## Проблема

Если вы получаете ошибку `The query requires an index`, это означает, что для вашего запроса нужен составной индекс в Firestore.

## Решение

### Автоматическое создание индекса (рекомендуется)

Firebase предоставляет прямую ссылку для создания индекса. Когда вы получите ошибку:

1. **Скопируйте ссылку** из сообщения об ошибке (она выглядит примерно так):
   ```
   https://console.firebase.google.com/v1/r/project/alla-cosmetology/firestore/indexes?create_composite=...
   ```

2. **Откройте ссылку** в браузере - она автоматически откроет страницу создания индекса в Firebase Console

3. **Нажмите "Create Index"** (Создать индекс)

4. **Дождитесь создания** - обычно это занимает несколько минут

### Ручное создание индекса

Если автоматическая ссылка не работает:

1. Перейдите в [Firebase Console](https://console.firebase.google.com/)
2. Выберите проект `alla-cosmetology`
3. Перейдите в **Firestore Database** → **Indexes** (Индексы)
4. Нажмите **Create Index** (Создать индекс)
5. Заполните следующие поля:

#### Индекс для serviceRecords (по clientId и date)

- **Collection ID**: `serviceRecords`
- **Fields to index**:
  - `clientId` - Ascending (По возрастанию)
  - `date` - Descending (По убыванию)
  - `__name__` - Descending (По убыванию) - добавляется автоматически
- **Query scope**: Collection
- Нажмите **Create** (Создать)

#### Индекс для serviceRecords (по clientPhone и date)

- **Collection ID**: `serviceRecords`
- **Fields to index**:
  - `clientPhone` - Ascending (По возрастанию)
  - `date` - Descending (По убыванию)
  - `__name__` - Descending (По убыванию) - добавляется автоматически
- **Query scope**: Collection
- Нажмите **Create** (Создать)

### Проверка статуса индекса

После создания индекса:

1. Перейдите в **Firestore Database** → **Indexes**
2. Найдите созданный индекс в списке
3. Дождитесь, пока статус изменится с **Building** (Создается) на **Enabled** (Включен)

Обычно это занимает 1-5 минут.

### Альтернативное решение (без индекса)

Если вы не хотите создавать индексы, можно изменить запросы, чтобы они не требовали составных индексов. Однако это может ухудшить производительность.

**Важно**: Рекомендуется создать индексы, так как они оптимизируют запросы и улучшают производительность.

## Дополнительные индексы, которые могут понадобиться

Если в будущем появятся другие ошибки с индексами, создайте их аналогичным образом:

- Для запросов с несколькими `where` условиями
- Для запросов с `where` + `orderBy` по разным полям
- Для запросов с несколькими `orderBy`

## Проверка работы

После создания индекса:

1. Обновите страницу в браузере
2. Попробуйте снова открыть историю клиента
3. Ошибка должна исчезнуть

## Полезные ссылки

- [Документация Firebase по индексам](https://firebase.google.com/docs/firestore/query-data/indexing)
- [Лучшие практики индексирования](https://firebase.google.com/docs/firestore/query-data/indexing-best-practices)

