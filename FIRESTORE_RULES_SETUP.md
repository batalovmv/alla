# Настройка правил безопасности Firestore

## Проблема

Если вы получаете ошибку `Missing or insufficient permissions` при отправке заявки, это означает, что правила безопасности Firestore не настроены правильно.

## Решение

### Шаг 1: Откройте консоль Firebase

1. Перейдите на https://console.firebase.google.com/
2. Выберите ваш проект `alla-cosmetology`
3. В левом меню выберите **Firestore Database**
4. Перейдите на вкладку **Rules** (Правила)

### Шаг 2: Установите следующие правила

Скопируйте и вставьте следующие правила в редактор правил:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Функция для проверки авторизации администратора
    function isAdmin() {
      return request.auth != null && request.auth.uid != null;
    }
    
    // Процедуры - публичное чтение, только админы могут писать
    match /procedures/{procedureId} {
      allow read: if true; // Все могут читать
      allow write: if isAdmin(); // Только админы могут создавать/обновлять/удалять
    }
    
    // Отзывы - публичное чтение одобренных, публичное создание, только админы могут модерацию
    match /reviews/{reviewId} {
      allow read: if true; // Все могут читать
      allow create: if true; // Все могут создавать отзывы
      allow update, delete: if isAdmin(); // Только админы могут обновлять/удалять
    }
    
    // Заявки - публичное создание, только админы могут читать/обновлять/удалять
    match /bookings/{bookingId} {
      allow create: if true; // Все могут создавать заявки
      allow read, update, delete: if isAdmin(); // Только админы могут читать/обновлять/удалять
    }
    
    // Клиенты - публичное создание и обновление (при создании заявки), только админы могут читать/удалять
    match /clients/{clientId} {
      allow create: if true; // Все могут создавать клиентов (при создании заявки)
      allow update: if true; // Все могут обновлять клиентов (при обновлении заявки)
      allow read, delete: if isAdmin(); // Только админы могут читать/удалять
    }
    
    // Записи об оказанных услугах - только админы
    match /serviceRecords/{recordId} {
      allow read, write: if isAdmin(); // Только админы
    }
    
    // Контактная информация - публичное чтение, только админы могут обновлять
    match /contactInfo/{document} {
      allow read: if true; // Все могут читать
      allow write: if isAdmin(); // Только админы могут обновлять
    }
    
    // Информация "О специалисте" - публичное чтение, только админы могут обновлять
    match /aboutInfo/{document} {
      allow read: if true; // Все могут читать
      allow write: if isAdmin(); // Только админы могут обновлять
    }
  }
}
```

### Шаг 3: Опубликуйте правила

1. Нажмите кнопку **Publish** (Опубликовать)
2. Дождитесь подтверждения, что правила опубликованы

### Шаг 4: Проверьте работу

После публикации правил попробуйте снова отправить заявку. Ошибка должна исчезнуть.

## Важные замечания

### Безопасность

⚠️ **Внимание**: Эти правила позволяют любому пользователю создавать заявки и клиентов. Это нормально для публичного сайта, но убедитесь, что:

1. **Админ-панель защищена** - только авторизованные пользователи могут входить в админку
2. **Чувствительные данные защищены** - записи об услугах (`serviceRecords`) доступны только админам
3. **Заявки защищены** - только админы могут видеть и управлять заявками

### Альтернативный вариант (более строгий)

Если вы хотите более строгие правила, можно добавить проверку на наличие определенных полей:

```javascript
// Для заявок - проверка обязательных полей
match /bookings/{bookingId} {
  allow create: if request.resource.data.keys().hasAll(['name', 'phone', 'procedureId', 'desiredDate', 'desiredTime'])
                 && request.resource.data.name is string
                 && request.resource.data.phone is string;
  allow read, update, delete: if isAdmin();
}
```

Но для начала используйте более простые правила выше.

## Проверка правил

После настройки правил вы можете проверить их работу:

1. **Публичный доступ**: Откройте сайт в режиме инкогнито (без авторизации) и попробуйте:
   - Просмотреть процедуры ✅
   - Просмотреть отзывы ✅
   - Отправить заявку ✅
   - Просмотреть заявки ❌ (должна быть ошибка)

2. **Админский доступ**: Войдите в админ-панель и проверьте:
   - Просмотр заявок ✅
   - Просмотр клиентов ✅
   - Создание/редактирование процедур ✅
   - Модерация отзывов ✅

## Дополнительная информация

Если у вас все еще возникают проблемы:

1. Проверьте, что вы используете правильный проект Firebase
2. Убедитесь, что Firebase Authentication включен
3. Проверьте, что вы авторизованы в админ-панели (для админских операций)
4. Посмотрите логи в консоли браузера для более детальной информации об ошибке

